<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VC AI Incubator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@300;400;500;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    /* ── Design tokens (Phase 2) ── */
    --gold: #d4a853;
    --gold-dim: rgba(212,168,83,.13);
    --gold-glow: rgba(212,168,83,.35);
    --ink: #0c0d10;
    --ink-2: #141519;
    --border-hi: rgba(255,255,255,.14);
    --text-dim: #8a8c96;
    --text-xs: #5a5c68;

    /* Provider colour tokens */
    --c-openai: #10b981;
    --c-anthropic: #cc785c;
    --c-compat: #6d7aff;
    --c-mistral: #ff7000;
    --c-google: #8b5cf6;
    --c-deepseek: #3b82f6;
    --c-xai: #e2e2e2;
    --c-meta: #0082fb;
    --c-cohere: #39d353;
    --c-qwen: #ed6c18;

    /* Font tokens */
    --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
    --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-serif: 'DM Serif Display', serif;

    --bg: #0f1117; --surface: #1a1d27; --surface2: #22253a; --border: #2a2d3a;
    --text: #e4e4e7; --muted: #8b8d97; --accent: #6366f1;
    --green: #22c55e; --red: #ef4444; --yellow: #eab308; --blue: #3b82f6;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font-sans); background: var(--bg); color: var(--text); line-height: 1.5; }
  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

  header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
  header h1 { font-size: 24px; font-weight: 700; }
  header h1 span { color: var(--accent); }
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
  .status-dot.connected { background: var(--green); }
  .status-dot.disconnected { background: var(--red); }

  /* Control Panel */
  .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
  .panel h2 { font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .panel-section { background: var(--surface2); border-radius: 8px; padding: 16px; }
  .panel-section h3 { font-size: 13px; color: var(--accent); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 12px; font-weight: 600; }

  .field { margin-bottom: 12px; }
  .field:last-child { margin-bottom: 0; }
  .field label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; font-weight: 500; }
  .field input, .field select { width: 100%; background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; font-size: 14px; transition: border-color .15s; }
  .field input:focus, .field select:focus { outline: none; border-color: var(--accent); }
  .field input[type="password"] { font-family: monospace; letter-spacing: 1px; }
  .field .hint { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .field-row { display: flex; gap: 12px; }
  .field-row .field { flex: 1; }

  .actions { display: flex; gap: 12px; align-items: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }
  button { background: var(--accent); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600; transition: all .15s; }
  button:hover { opacity: .85; transform: translateY(-1px); }
  button:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  button.secondary { background: var(--surface2); border: 1px solid var(--border); font-weight: 500; }
  button.lg { padding: 12px 32px; font-size: 16px; }
  .run-status { font-size: 13px; color: var(--muted); }

  /* Tabs */
  .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .tab { padding: 10px 20px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; transition: all .15s; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Progress */
  .progress-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 24px; display: none; }
  .progress-bar { background: var(--bg); border-radius: 8px; overflow: hidden; height: 6px; margin: 12px 0; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--blue)); transition: width .3s; border-radius: 8px; }
  .stage-badges { display: flex; gap: 8px; margin-bottom: 12px; }
  .stage-badge { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: var(--bg); border: 1px solid var(--border); }
  .stage-badge.active { background: var(--accent); border-color: var(--accent); color: white; animation: pulse 2s infinite; }
  .stage-badge.complete { background: rgba(34,197,94,.15); border-color: var(--green); color: var(--green); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .7; } }

  .event-log { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; max-height: 250px; overflow-y: auto; padding: 12px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
  .event { padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,.03); }
  .event:last-child { border-bottom: none; }
  .event .ts { color: var(--muted); margin-right: 8px; }
  .event .type { color: var(--accent); margin-right: 8px; font-weight: 500; }

  /* Cards */
  .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: border-color .15s; }
  .card:hover { border-color: var(--accent); }
  .card h3 { font-size: 16px; margin-bottom: 8px; }
  .card .provider { font-size: 11px; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
  .card p { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 4px; }
  .tag.invest { background: rgba(34,197,94,.15); color: var(--green); }
  .tag.pass { background: rgba(239,68,68,.15); color: var(--red); }

  /* Table */
  table { width: 100%; border-collapse: collapse; }
  th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
  th { color: var(--muted); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
  tr:hover td { background: rgba(99,102,241,.05); }

  details { margin-bottom: 12px; }
  summary { cursor: pointer; padding: 8px 0; font-weight: 500; }
  summary:hover { color: var(--accent); }
  details .content { padding: 16px; background: var(--surface); border-radius: 8px; margin-top: 8px; font-size: 13px; line-height: 1.6; }
  details .content h4 { color: var(--accent); font-size: 12px; text-transform: uppercase; letter-spacing: .5px; margin: 12px 0 6px; }
  details .content h4:first-child { margin-top: 0; }

  .empty { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty h2 { font-size: 20px; margin-bottom: 8px; color: var(--text); }

  .key-warning { background: rgba(234,179,8,.1); border: 1px solid rgba(234,179,8,.3); border-radius: 6px; padding: 10px 14px; font-size: 12px; color: var(--yellow); margin-top: 8px; }
  .tier-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; margin-right: 6px; }
  .tier-frontier   { background: rgba(99,102,241,.2);  color: var(--accent); border: 1px solid rgba(99,102,241,.4); }
  .tier-strong     { background: rgba(59,130,246,.2);  color: var(--blue);   border: 1px solid rgba(59,130,246,.4); }
  .tier-efficient  { background: rgba(234,179,8,.18);  color: var(--yellow); border: 1px solid rgba(234,179,8,.4); }
  .tier-budget     { background: rgba(34,197,94,.2);   color: var(--green);  border: 1px solid rgba(34,197,94,.4); }
  .tier-open-source{ background: rgba(139,92,246,.18); color: #a78bfa;       border: 1px solid rgba(139,92,246,.4); }
  .tier-standard   { background: rgba(59,130,246,.2);  color: var(--blue);   border: 1px solid rgba(59,130,246,.4); }
  .tier-local      { background: rgba(139,141,151,.2); color: var(--muted);  border: 1px solid rgba(139,141,151,.4); }
  .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
  .catalog-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: border-color .15s; }
  .catalog-card:hover { border-color: var(--accent); }
  .catalog-card .model-id { font-family: monospace; font-size: 13px; color: var(--accent); margin-bottom: 4px; }
  .catalog-card .provider-name { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 10px; }
  .catalog-card .pricing { display: flex; gap: 16px; margin: 10px 0; padding: 8px 12px; background: var(--bg); border-radius: 6px; font-size: 12px; }
  .catalog-card .price-item { display: flex; flex-direction: column; gap: 2px; }
  .catalog-card .price-label { color: var(--muted); font-size: 10px; text-transform: uppercase; }
  .catalog-card .price-val { font-weight: 700; color: var(--text); }
  .catalog-card ul { margin: 6px 0 0 16px; font-size: 12px; color: var(--muted); }
  .catalog-card ul li { margin-bottom: 2px; }
  .role-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin: 2px; background: rgba(99,102,241,.15); color: var(--accent); border: 1px solid rgba(99,102,241,.3); }
  .estimate-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-top: 16px; }
  .estimate-box .total { font-size: 28px; font-weight: 800; color: var(--accent); }
  .estimate-box .sub { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .estimate-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .estimate-row:last-child { border-bottom: none; }
  .toggle-row { display: flex; align-items: center; justify-content: space-between; }
  .toggle { position: relative; display: inline-block; width: 40px; height: 22px; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: var(--border); border-radius: 22px; transition: .2s; }
  .toggle-slider:before { content: ''; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .2s; }
  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider:before { transform: translateX(18px); }
  .catalog-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .filter-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: 500; }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

  /* ── Provider badge: data-prov colour system (STYLE-03) ── */
  /* Default / fallback: compat purple */
  .provider-badge,
  .eprov { color: var(--c-compat); }
  [data-prov="openai"]    { color: var(--c-openai); }
  [data-prov="anthropic"] { color: var(--c-anthropic); }
  [data-prov="deepseek"]  { color: var(--c-deepseek); }
  [data-prov="gemini"],
  [data-prov="google"]    { color: var(--c-google); }
  [data-prov="mistral"]   { color: var(--c-mistral); }
  [data-prov="xai"]       { color: var(--c-xai); }
  [data-prov="meta"]      { color: var(--c-meta); }
  [data-prov="cohere"]    { color: var(--c-cohere); }
  [data-prov="qwen"]      { color: var(--c-qwen); }

/* ═══════════════════ TEAM BUILDER ═══════════════════ */
.team-builder-section {
  background: var(--surface2);
  border-radius: 8px;
  padding: 0;
  overflow: hidden;
  grid-column: 1 / -1;  /* spans full panel-grid width */
  margin-top: 4px;
}
.team-builder-head {
  padding: 14px 16px 10px;
  border-bottom: 1px solid var(--border);
}
.team-builder-head h3 {
  font-size: 13px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: .5px;
  margin-bottom: 2px;
  font-weight: 600;
}
.team-builder-head p {
  font-size: 11px;
  color: var(--muted);
}
/* 4-slot selector strip */
.slot-strip {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  border-bottom: 1px solid var(--border);
}
.slot-btn {
  padding: 10px 12px;
  cursor: pointer;
  border-right: 1px solid var(--border);
  transition: background .15s;
  position: relative;
}
.slot-btn:last-child { border-right: none; }
.slot-btn:hover { background: rgba(255,255,255,.02); }
.slot-btn.active { background: rgba(255,255,255,.03); }
.slot-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 2px;
  background: currentColor;
}
.slot-label {
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 3px;
}
.slot-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: currentColor;
  display: inline-block;
  margin-right: 4px;
  vertical-align: middle;
}
.slot-type-line { font-size: 9px; color: var(--muted); margin-bottom: 5px; }
.slot-selected-name { font-size: 12px; font-weight: 600; }
.slot-selected-price { font-size: 10px; color: var(--muted); margin-top: 1px; }
/* Slot accent colours */
.slot-btn[data-slot="0"] { color: var(--c-openai); }
.slot-btn[data-slot="1"] { color: var(--c-anthropic); }
.slot-btn[data-slot="2"] { color: var(--c-compat); }
.slot-btn[data-slot="3"] { color: var(--c-compat); }
/* Picker panel */
.picker-panel {
  display: none;
  flex-direction: column;
  min-height: 280px;
  max-height: 340px;
  overflow: hidden;
}
.picker-panel.active { display: flex; }
/* Provider selector tabs */
.provider-selector {
  display: flex;
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
  scrollbar-width: none;
}
.provider-selector::-webkit-scrollbar { display: none; }
.prov-tab {
  flex-shrink: 0;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 10px;
  font-weight: 600;
  color: var(--muted);
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: all .15s;
  display: flex;
  align-items: center;
  gap: 4px;
}
.prov-tab:hover { color: var(--text); }
.prov-tab.active { color: var(--text); border-bottom-color: currentColor; }
.prov-tab .pd {
  width: 7px; height: 7px;
  border-radius: 2px;
  flex-shrink: 0;
}
/* Model list */
.model-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 10px 14px;
}
.model-scroll::-webkit-scrollbar { width: 3px; }
.model-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.model-row {
  display: flex;
  align-items: flex-start;
  gap: 9px;
  padding: 8px 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: background .12s;
  border: 1px solid transparent;
  margin-bottom: 3px;
}
.model-row:hover { background: var(--bg); }
.model-row.selected { background: var(--bg); border-color: currentColor; }
.model-row input[type="radio"] { display: none; }
.model-radio-dot {
  width: 13px; height: 13px;
  border-radius: 50%;
  border: 2px solid var(--border);
  flex-shrink: 0;
  margin-top: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .12s;
}
.model-row.selected .model-radio-dot {
  background: currentColor;
  border-color: currentColor;
}
.model-row.selected .model-radio-dot::after {
  content: '';
  width: 4px; height: 4px;
  border-radius: 50%;
  background: var(--surface);
}
.model-info { flex: 1; min-width: 0; }
.model-name { font-size: 12px; font-weight: 500; margin-bottom: 3px; }
.model-tagrow { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 2px; }
.mtag {
  font-size: 9px;
  padding: 1px 5px;
  border-radius: 3px;
  border: 1px solid rgba(255,255,255,.07);
  color: var(--muted);
}
.mtag.price { color: var(--yellow); border-color: rgba(234,179,8,.25); }
.mtag.ctx  { color: var(--blue); border-color: rgba(59,130,246,.2); }
.mtag.tier-flagship { color: var(--muted); }
.mtag.tier-fast { color: var(--green); border-color: rgba(34,197,94,.2); }
.mtag.tier-cheap { color: #f97316; border-color: rgba(249,115,22,.2); }
.model-desc { font-size: 10px; color: var(--muted); line-height: 1.4; }
/* Base URL row */
.base-url-row {
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}
.base-url-row label {
  display: block;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: .5px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 0;
  white-space: nowrap;
  flex-shrink: 0;
}
.base-url-row input {
  font-family: monospace;
  font-size: 10px;
  padding: 5px 8px;
}
/* Team summary chips */
.team-summary {
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
  flex-shrink: 0;
}
.team-chip {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg);
}
.team-chip-dot { width: 5px; height: 5px; border-radius: 50%; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>VC</span> AI Incubator</h1>
    <div id="wsStatus"><span class="status-dot disconnected"></span> Disconnected</div>
  </header>

  <!-- Control Panel -->
  <div class="panel" id="controlPanel">
    <h2>Control Panel</h2>
    <div class="panel-grid">

      <!-- Pipeline Settings -->
      <div class="panel-section">
        <h3>Pipeline Settings</h3>
        <div class="field-row">
          <div class="field">
            <label>Number of Startups (per model)</label>
            <select id="cfgIdeas"><option value="3">3</option><option value="5" selected>5</option><option value="7">7</option><option value="10">10</option></select>
          </div>
          <div class="field">
            <label>Iteration Rounds</label>
            <select id="cfgIter"><option value="1">1</option><option value="2">2</option><option value="3" selected>3</option></select>
          </div>
        </div>
        <div class="field">
          <label>Sector Focus (optional)</label>
          <input type="text" id="cfgSector" placeholder="e.g. Healthcare, Fintech, Climate Tech, AI/ML...">
          <div class="hint">Leave empty for diverse ideas across all sectors</div>
        </div>
        <div class="field">
          <label>Mode</label>
          <select id="cfgMock">
            <option value="true">Mock (no API keys needed)</option>
            <option value="false">Live (real API calls)</option>
          </select>
        </div>
        <div class="field">
          <div class="toggle-row">
            <div>
              <div style="font-size:12px;color:var(--muted);font-weight:500">Advisor Deliberation</div>
              <div class="hint">Lead advisor synthesizes all reviews before founder iterates</div>
            </div>
            <label class="toggle"><input type="checkbox" id="cfgDeliberation"><span class="toggle-slider"></span></label>
          </div>
        </div>
      </div>

      <!-- Team Builder (replaces flat model dropdowns) -->
      <div class="team-builder-section">
        <div class="team-builder-head">
          <h3>AI Panel</h3>
          <p>4 providers compete as founders, advisors &amp; investors. Slots 3 &amp; 4 accept any OpenAI-compatible API.</p>
        </div>
        <div class="slot-strip" id="slotStrip"></div>
        <div id="pickerPanels" style="position:relative"></div>
        <div class="team-summary" id="teamSummary"></div>
      </div>

      <!-- API Keys -->
      <div class="panel-section">
        <h3>API Keys</h3>
        <div class="field">
          <label>OpenAI API Key</label>
          <input type="password" id="keyOpenai" placeholder="sk-...">
        </div>
        <div class="field">
          <label>Anthropic API Key</label>
          <input type="password" id="keyAnthropic" placeholder="sk-ant-...">
        </div>
        <div class="field">
          <label>DeepSeek API Key</label>
          <input type="password" id="keyDeepseek" placeholder="sk-...">
        </div>
        <div class="field">
          <label>Gemini API Key</label>
          <input type="password" id="keyGemini" placeholder="AI...">
        </div>
        <div class="key-warning">
          Keys are sent to the server over your connection and used only for this run. They are never stored to disk or logged. For production, use .env files instead.
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="lg" id="btnRun" onclick="startRun()">Launch Incubator</button>
      <button class="secondary" onclick="loadRuns()">Refresh Runs</button>
      <button class="secondary" onclick="runEstimate()">Estimate Cost</button>
      <span class="run-status" id="runStatus"></span>
    </div>
    <div id="estimateResult" style="display:none"></div>
  </div>

  <!-- Progress Section -->
  <div class="progress-section" id="progressSection">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Pipeline Progress</strong>
      <span class="run-status" id="progressStatus"></span>
    </div>
    <div class="stage-badges" id="stageBadges">
      <div class="stage-badge" data-stage="stage1">Stage 1: Ideate & Select</div>
      <div class="stage-badge" data-stage="stage2">Stage 2: Build & Iterate</div>
      <div class="stage-badge" data-stage="stage3">Stage 3: Seed Pitch</div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="event-log" id="eventLog"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="mainTabs">
    <div class="tab active" data-tab="runs">Run History</div>
    <div class="tab" data-tab="ideas">Ideas</div>
    <div class="tab" data-tab="plans">Startup Plans</div>
    <div class="tab" data-tab="pitches">Pitches & Decisions</div>
    <div class="tab" data-tab="portfolio">Portfolio Report</div>    <div class="tab" data-tab="catalog">Model Catalog</div>  </div>

  <div class="tab-content active" id="tab-runs">
    <div id="runsList" class="empty"><h2>No runs yet</h2><p>Configure the control panel above and click "Launch Incubator" to start.</p></div>
  </div>
  <div class="tab-content" id="tab-ideas"><div id="ideasContent" class="empty"><p>Run a pipeline to see ideas here.</p></div></div>
  <div class="tab-content" id="tab-plans"><div id="plansContent" class="empty"><p>Run a pipeline to see startup plans here.</p></div></div>
  <div class="tab-content" id="tab-pitches"><div id="pitchesContent" class="empty"><p>Run a pipeline to see pitches and investor decisions here.</p></div></div>
  <div class="tab-content" id="tab-portfolio"><div id="portfolioContent" class="empty"><p>Run a pipeline to see the portfolio report here.</p></div></div>
  <div class="tab-content" id="tab-catalog">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h2 style="font-size:18px">Model Catalog</h2>
      <button class="secondary" onclick="loadCatalog()" style="padding:6px 14px;font-size:12px">Refresh</button>
    </div>
    <div class="catalog-filters" id="catalogFilters">
      <span style="font-size:12px;color:var(--muted);font-weight:500">Filter by tier:</span>
      <button class="filter-btn active" onclick="filterCatalog('all', this)">All</button>
      <button class="filter-btn" onclick="filterCatalog('frontier', this)">Frontier</button>
      <button class="filter-btn" onclick="filterCatalog('strong', this)">Strong</button>
      <button class="filter-btn" onclick="filterCatalog('efficient', this)">Efficient</button>
      <button class="filter-btn" onclick="filterCatalog('budget', this)">Budget</button>
      <button class="filter-btn" onclick="filterCatalog('open-source', this)">Open-Source</button>
    </div>
    <div id="catalogContent" class="empty"><p>Loading catalog...</p></div>
  </div>
</div>

<script>
/* ════════════════════════════════════════════════════
   TEAM BUILDER — slot data and UI logic
════════════════════════════════════════════════════ */
const SLOTS = [
  {
    label: 'Slot 1', type: 'OpenAI Responses API',
    color: 'var(--c-openai)', keyField: 'keyOpenai',
    configKey: 'openai',   // maps to models.openai in RunConfig
    fixed: true, defaultModel: 'gpt-4o',
    providers: [
      {
        name: 'OpenAI', color: 'var(--c-openai)',
        baseUrl: 'https://api.openai.com/v1',
        models: [
          { id:'gpt-4o',           name:'GPT-4o',         price:'$2.50/$10',   ctx:'128K', tier:'flagship', desc:'Best general-purpose model. Strong reasoning and code.' },
          { id:'gpt-4o-mini',      name:'GPT-4o Mini',    price:'$0.15/$0.60', ctx:'128K', tier:'fast',     desc:'Fast and cheap. Best value for high-volume tasks.' },
          { id:'o3-mini',          name:'o3-mini',         price:'$1.10/$4.4',  ctx:'200K', tier:'flagship', desc:'Efficient chain-of-thought reasoning.' },
          { id:'gpt-4.1',          name:'GPT-4.1',         price:'$2.00/$8',    ctx:'1M',   tier:'fast',     desc:'1M context. Strong for long-document work.' },
          { id:'gpt-4.1-mini',     name:'GPT-4.1 mini',   price:'$0.40/$1.60', ctx:'1M',   tier:'fast',     desc:'Cost-efficient with massive context.' },
        ]
      }
    ]
  },
  {
    label: 'Slot 2', type: 'Anthropic Messages API',
    color: 'var(--c-anthropic)', keyField: 'keyAnthropic',
    configKey: 'anthropic', fixed: true,
    defaultModel: 'claude-3-5-haiku-20241022',
    providers: [
      {
        name: 'Anthropic', color: 'var(--c-anthropic)',
        baseUrl: 'https://api.anthropic.com/v1',
        models: [
          { id:'claude-opus-4-6',   name:'Claude Opus 4.6',   price:'$5/$25',    ctx:'200K', tier:'flagship', desc:'Best instruction-following. Top choice for investor/advisor roles.' },
          { id:'claude-sonnet-4-6', name:'Claude Sonnet 4.6', price:'$3/$15',    ctx:'200K', tier:'flagship', desc:'Best capability-cost ratio in the Claude family.' },
          { id:'claude-sonnet-4-5', name:'Claude Sonnet 4.5', price:'$3/$15',    ctx:'200K', tier:'flagship', desc:'Optimised for agentic and iterative work.' },
          { id:'claude-3-5-haiku-20241022', name:'Claude Haiku 3.5', price:'$0.80/$4', ctx:'200K', tier:'fast', desc:'Near-frontier quality at lower cost. Fastest Claude.' },
        ]
      }
    ]
  },
  {
    label: 'Slot 3', type: 'OpenAI-Compatible API',
    color: 'var(--c-compat)', keyField: 'keyDeepseek',
    configKey: 'deepseek',  // maps to models.deepseek in RunConfig
    fixed: false, defaultModel: 'deepseek-chat',
    defaultProvider: 'DeepSeek',
    defaultBaseUrl: 'https://api.deepseek.com/v1',
    providers: [
      {
        name: 'DeepSeek', color: 'var(--c-deepseek)',
        baseUrl: 'https://api.deepseek.com/v1',
        models: [
          { id:'deepseek-reasoner', name:'DeepSeek Reasoner', price:'$0.55/$2.19', ctx:'64K', tier:'flagship', desc:'Chain-of-thought before JSON. Great for multi-step analysis.' },
          { id:'deepseek-chat',     name:'DeepSeek Chat',     price:'$0.27/$1.10', ctx:'64K', tier:'fast',     desc:'Lightest DeepSeek model. High-volume feedback tasks.' },
        ]
      },
      {
        name: 'Mistral', color: 'var(--c-mistral)',
        baseUrl: 'https://api.mistral.ai/v1',
        models: [
          { id:'mistral-large-latest',  name:'Mistral Large',  price:'$2/$6',       ctx:'128K', tier:'flagship', desc:'Strong European reasoning. Excellent structured output.' },
          { id:'mistral-medium-latest', name:'Mistral Medium', price:'$0.40/$2',    ctx:'128K', tier:'fast',     desc:'Balanced quality and cost for advisor roles.' },
          { id:'mistral-small-latest',  name:'Mistral Small',  price:'$0.10/$0.30', ctx:'128K', tier:'cheap',   desc:'Highly cost-efficient. Reliable JSON output.' },
        ]
      },
      {
        name: 'xAI', color: 'var(--c-xai)',
        baseUrl: 'https://api.x.ai/v1',
        models: [
          { id:'grok-3',      name:'Grok 3',      price:'$3/$15',    ctx:'131K', tier:'flagship', desc:'Real-world reasoning with live knowledge integration.' },
          { id:'grok-3-mini', name:'Grok 3 Mini', price:'$0.30/$0.50', ctx:'131K', tier:'fast', desc:'Cost-efficient Grok for advisor and feedback roles.' },
        ]
      },
      {
        name: 'Meta', color: 'var(--c-meta)',
        baseUrl: 'https://api.together.xyz/v1',
        models: [
          { id:'meta-llama/Llama-4-Maverick-17B-128E-Instruct-FP8', name:'Llama 4 Maverick', price:'$0.27/$0.85', ctx:'1M',  tier:'flagship', desc:'Open-weights via Together AI. Competitive with mid-tier closed models.' },
          { id:'meta-llama/Llama-3.3-70B-Instruct-Turbo',           name:'Llama 3.3 70B',    price:'$0.90/$0.90', ctx:'128K',tier:'fast',     desc:'Proven and widely deployed. Reliable JSON output.' },
        ]
      },
      {
        name: 'Cohere', color: 'var(--c-cohere)',
        baseUrl: 'https://api.cohere.ai/compatibility/v1',
        models: [
          { id:'command-a-03-2025',   name:'Command A',  price:'$2.77/$13.72', ctx:'256K', tier:'flagship', desc:'Cohere flagship for agentic tasks and RAG.' },
          { id:'command-r-08-2024',   name:'Command R',  price:'$0.15/$0.60',  ctx:'128K', tier:'cheap',    desc:'Budget option for structured retrieval tasks.' },
        ]
      },
      {
        name: 'Qwen', color: 'var(--c-qwen)',
        baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
        models: [
          { id:'Qwen/Qwen3-235B-A22B', name:'Qwen3 235B', price:'$0 (preview)', ctx:'131K', tier:'flagship', desc:'235B parameter model. Competitive reasoning.' },
          { id:'Qwen/Qwen3-72B',       name:'Qwen3 72B',  price:'~$0.90/$0.90', ctx:'131K', tier:'fast',    desc:'Strong mid-size open model.' },
        ]
      },
    ]
  },
  {
    label: 'Slot 4', type: 'OpenAI-Compatible API',
    color: 'var(--c-google)', keyField: 'keyGemini',
    configKey: 'gemini',    // maps to models.gemini in RunConfig
    fixed: false, defaultModel: 'gemini-2.0-flash',
    defaultProvider: 'Google',
    defaultBaseUrl: 'https://generativelanguage.googleapis.com/v1beta/openai',
    providers: [
      {
        name: 'Google', color: 'var(--c-google)',
        baseUrl: 'https://generativelanguage.googleapis.com/v1beta/openai',
        models: [
          { id:'gemini-3.1-pro-preview', name:'Gemini 3.1 Pro',      price:'$2/$12',      ctx:'1M',   tier:'flagship', desc:'Frontier Gemini. Massive 1M context. Top scientific and coding benchmarks.' },
          { id:'gemini-3-flash',         name:'Gemini 3 Flash',       price:'$0.50/$3',    ctx:'1M',   tier:'fast',     desc:'Fast Flash model with 1M context. Great for bulk feedback rounds.' },
          { id:'gemini-2.0-flash',       name:'Gemini 2.0 Flash',     price:'$0.10/$0.40', ctx:'1M',   tier:'cheap',    desc:'Confirmed stable model. Fastest Google option at near-zero cost.' },
          { id:'gemini-1.5-pro',         name:'Gemini 1.5 Pro',       price:'$1.25/$5',    ctx:'2M',   tier:'flagship', desc:'2M context window. Proven model for long-document analysis.' },
        ]
      },
      {
        name: 'DeepSeek', color: 'var(--c-deepseek)',
        baseUrl: 'https://api.deepseek.com/v1',
        models: [
          { id:'deepseek-reasoner', name:'DeepSeek Reasoner', price:'$0.55/$2.19', ctx:'64K', tier:'flagship', desc:'Chain-of-thought before JSON. Great for multi-step analysis.' },
          { id:'deepseek-chat',     name:'DeepSeek Chat',     price:'$0.27/$1.10', ctx:'64K', tier:'fast',     desc:'Lightest DeepSeek model. High-volume feedback tasks.' },
        ]
      },
      {
        name: 'Mistral', color: 'var(--c-mistral)',
        baseUrl: 'https://api.mistral.ai/v1',
        models: [
          { id:'mistral-large-latest',  name:'Mistral Large',  price:'$2/$6',       ctx:'128K', tier:'flagship', desc:'Strong European reasoning. Excellent structured output.' },
          { id:'mistral-medium-latest', name:'Mistral Medium', price:'$0.40/$2',    ctx:'128K', tier:'fast',     desc:'Balanced quality and cost for advisor roles.' },
          { id:'mistral-small-latest',  name:'Mistral Small',  price:'$0.10/$0.30', ctx:'128K', tier:'cheap',    desc:'Highly cost-efficient. Reliable JSON output.' },
        ]
      },
      {
        name: 'xAI', color: 'var(--c-xai)',
        baseUrl: 'https://api.x.ai/v1',
        models: [
          { id:'grok-3',      name:'Grok 3',      price:'$3/$15',      ctx:'131K', tier:'flagship', desc:'Real-world reasoning with live knowledge integration.' },
          { id:'grok-3-mini', name:'Grok 3 Mini', price:'$0.30/$0.50', ctx:'131K', tier:'fast',     desc:'Cost-efficient Grok for advisor and feedback roles.' },
        ]
      },
    ]
  },
];

/* ─── State ─── */
const teamState = {
  selectedSlot: 0,
  models:    {},   // slotIndex -> modelId
  providers: {},   // slotIndex -> providerName (compat slots only)
  baseUrls:  {},   // slotIndex -> baseUrl (compat slots only)
};
SLOTS.forEach((slot, i) => {
  teamState.models[i] = slot.defaultModel;
  if (!slot.fixed) {
    teamState.providers[i] = slot.defaultProvider;
    teamState.baseUrls[i]  = slot.defaultBaseUrl;
  }
});

/* ─── Build UI ─── */
function buildTeamUI() {
  buildSlotStrip();
  buildPickerPanels();
  updateTeamSummary();
  activateSlot(0);
}

function buildSlotStrip() {
  const strip = document.getElementById('slotStrip');
  if (!strip) return;
  SLOTS.forEach((slot, i) => {
    const btn = document.createElement('div');
    btn.className = 'slot-btn';
    btn.dataset.slot = i;
    btn.style.color = slot.color;
    btn.onclick = () => activateSlot(i);
    btn.innerHTML =
      '<div class="slot-label"><span class="slot-dot"></span>' + slot.label + '</div>' +
      '<div class="slot-type-line">' + slot.type + '</div>' +
      '<div class="slot-selected-name" id="slot-name-' + i + '">—</div>' +
      '<div class="slot-selected-price" id="slot-price-' + i + '"></div>';
    strip.appendChild(btn);
  });
}

function buildPickerPanels() {
  const container = document.getElementById('pickerPanels');
  if (!container) return;
  SLOTS.forEach((slot, si) => {
    const panel = document.createElement('div');
    panel.className = 'picker-panel';
    panel.id = 'picker-' + si;
    panel.style.color = slot.color;

    if (!slot.fixed) {
      const provSel = document.createElement('div');
      provSel.className = 'provider-selector';
      provSel.id = 'prov-sel-' + si;
      slot.providers.forEach(prov => {
        const tab = document.createElement('div');
        tab.className = 'prov-tab';
        tab.dataset.prov = prov.name;
        tab.style.color = prov.color;
        tab.onclick = () => switchProvider(si, prov.name);
        tab.innerHTML = '<span class="pd" style="background:' + prov.color + '"></span>' + prov.name;
        provSel.appendChild(tab);
      });
      panel.appendChild(provSel);
    }

    const scroll = document.createElement('div');
    scroll.className = 'model-scroll';
    scroll.id = 'model-list-' + si;
    panel.appendChild(scroll);

    if (!slot.fixed) {
      const urlRow = document.createElement('div');
      urlRow.className = 'base-url-row';
      urlRow.innerHTML =
        '<label>Base URL</label>' +
        '<input type="text" id="baseurl-' + si + '" value="' + (slot.defaultBaseUrl || '') + '" placeholder="https://api.provider.com/v1">';
      panel.appendChild(urlRow);
      urlRow.querySelector('input').addEventListener('input', function(e) {
        teamState.baseUrls[si] = e.target.value;
      });
    }

    container.appendChild(panel);
  });

  SLOTS.forEach((slot, si) => {
    const prov = slot.fixed
      ? slot.providers[0]
      : slot.providers.find(p => p.name === teamState.providers[si]);
    renderModelList(si, prov);
    if (!slot.fixed) activateProviderTab(si, teamState.providers[si]);
  });
}

function renderModelList(si, prov) {
  const list = document.getElementById('model-list-' + si);
  if (!list || !prov) return;
  const slot = SLOTS[si];
  list.innerHTML = '';
  prov.models.forEach(m => {
    const isSelected = teamState.models[si] === m.id;
    const row = document.createElement('label');
    row.className = 'model-row' + (isSelected ? ' selected' : '');
    row.style.color = slot.color;
    row.dataset.id = m.id;
    const tierTag = m.tier === 'flagship'
      ? '<span class="mtag tier-flagship">flagship</span>'
      : m.tier === 'fast'
        ? '<span class="mtag tier-fast">efficient</span>'
        : '<span class="mtag tier-cheap">budget</span>';
    row.innerHTML =
      '<input type="radio" name="m-' + si + '" value="' + m.id + '"' + (isSelected ? ' checked' : '') + '>' +
      '<div class="model-radio-dot"></div>' +
      '<div class="model-info">' +
        '<div class="model-name">' + m.name + '</div>' +
        '<div class="model-tagrow">' +
          '<span class="mtag price">' + m.price + '</span>' +
          '<span class="mtag ctx">' + m.ctx + ' ctx</span>' +
          tierTag +
        '</div>' +
        '<div class="model-desc">' + m.desc + '</div>' +
      '</div>';
    row.onclick = () => selectModel(si, m.id);
    list.appendChild(row);
  });
  updateSlotHeader(si);
}

function selectModel(si, modelId) {
  teamState.models[si] = modelId;
  document.querySelectorAll('#model-list-' + si + ' .model-row').forEach(row => {
    const sel = row.dataset.id === modelId;
    row.classList.toggle('selected', sel);
    const radio = row.querySelector('input');
    if (radio) radio.checked = sel;
  });
  updateSlotHeader(si);
  updateTeamSummary();
}

function switchProvider(si, provName) {
  teamState.providers[si] = provName;
  const prov = SLOTS[si].providers.find(p => p.name === provName);
  if (!prov) return;
  const urlInput = document.getElementById('baseurl-' + si);
  if (urlInput) { urlInput.value = prov.baseUrl; teamState.baseUrls[si] = prov.baseUrl; }
  if (!prov.models.find(m => m.id === teamState.models[si])) {
    teamState.models[si] = prov.models[0].id;
  }
  activateProviderTab(si, provName);
  renderModelList(si, prov);
}

function activateProviderTab(si, provName) {
  const sel = document.getElementById('prov-sel-' + si);
  if (!sel) return;
  sel.querySelectorAll('.prov-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.prov === provName);
  });
}

function activateSlot(si) {
  teamState.selectedSlot = si;
  document.querySelectorAll('.slot-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.slot) === si);
  });
  document.querySelectorAll('.picker-panel').forEach(p => {
    p.classList.toggle('active', p.id === 'picker-' + si);
  });
}

function updateSlotHeader(si) {
  const slot = SLOTS[si];
  const prov = slot.fixed
    ? slot.providers[0]
    : slot.providers.find(p => p.name === teamState.providers[si]);
  const model = prov && prov.models.find(m => m.id === teamState.models[si]);
  const nameEl  = document.getElementById('slot-name-' + si);
  const priceEl = document.getElementById('slot-price-' + si);
  if (nameEl)  nameEl.textContent  = model ? model.name  : '—';
  if (priceEl) priceEl.textContent = model ? model.price : '';
}

function updateTeamSummary() {
  const summary = document.getElementById('teamSummary');
  if (!summary) return;
  const chips = SLOTS.map((slot, si) => {
    const prov = slot.fixed
      ? slot.providers[0]
      : slot.providers.find(p => p.name === teamState.providers[si]);
    const model = prov && prov.models.find(m => m.id === teamState.models[si]);
    const provLabel = (!slot.fixed && teamState.providers[si])
      ? teamState.providers[si] + ' · '
      : '';
    return '<div class="team-chip">' +
      '<div class="team-chip-dot" style="background:' + slot.color + '"></div>' +
      '<span style="color:var(--muted);margin-right:2px">' + slot.label + ':</span>' +
      provLabel + (model ? model.name : '—') +
      '</div>';
  });
  summary.innerHTML = chips.join('');
}

let ws = null;
let currentRunId = null;

// -- WebSocket --
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    document.getElementById('wsStatus').innerHTML = '<span class="status-dot connected"></span> Connected';
  };
  ws.onclose = () => {
    document.getElementById('wsStatus').innerHTML = '<span class="status-dot disconnected"></span> Reconnecting...';
    setTimeout(connectWS, 2000);
  };
  ws.onmessage = (e) => {
    const event = JSON.parse(e.data);
    if (event.type !== 'pong') handleEvent(event);
  };
}

function handleEvent(event) {
  const log = document.getElementById('eventLog');
  const section = document.getElementById('progressSection');
  section.style.display = 'block';

  // Stage badges
  if (event.type === 'stage_start') {
    document.querySelectorAll('.stage-badge').forEach(b => b.classList.remove('active'));
    const badge = document.querySelector(`[data-stage="${event.stage}"]`);
    if (badge) badge.classList.add('active');
    document.getElementById('progressStatus').textContent = event.message;
  }
  if (event.type === 'stage_complete') {
    const badge = document.querySelector(`[data-stage="${event.stage}"]`);
    if (badge) { badge.classList.remove('active'); badge.classList.add('complete'); }
  }

  // Progress bar
  const prog = { stage1: 33, stage2: 66, stage3: 100 };
  if (event.stage && prog[event.stage]) {
    const pct = event.type.includes('complete') ? prog[event.stage] : prog[event.stage] - 15;
    document.getElementById('progressFill').style.width = Math.min(pct, 100) + '%';
  }

  if (event.type === 'pipeline_complete') {
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('progressStatus').textContent = 'Complete!';
    document.getElementById('btnRun').disabled = false;
    document.getElementById('runStatus').textContent = '';
    if (currentRunId) loadResults(currentRunId);
  }
  if (event.type === 'pipeline_error') {
    document.getElementById('btnRun').disabled = false;
    document.getElementById('runStatus').textContent = '';
    document.getElementById('progressStatus').textContent = 'Error: ' + event.message;
    document.getElementById('progressStatus').style.color = 'var(--red)';
  }

  // Log entry
  const ts = new Date(event.timestamp * 1000).toLocaleTimeString();
  const div = document.createElement('div');
  div.className = 'event';
  const prov = (event.provider || '').toLowerCase();
  const provTag = event.provider ? ` <span class="eprov" data-prov="${prov}">[${event.provider}]</span>` : '';
  div.innerHTML = `<span class="ts">${ts}</span><span class="type">${event.type}</span>${event.message || ''}${provTag}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// -- API calls --
async function startRun() {
  const btn = document.getElementById('btnRun');
  btn.disabled = true;
  document.getElementById('runStatus').textContent = 'Starting pipeline...';

  // Reset progress
  document.querySelectorAll('.stage-badge').forEach(b => b.classList.remove('active', 'complete'));
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('eventLog').innerHTML = '';
  document.getElementById('progressSection').style.display = 'block';
  document.getElementById('progressStatus').textContent = 'Initializing...';
  document.getElementById('progressStatus').style.color = '';

  const useMock = document.getElementById('cfgMock').value === 'true';

  const config = {
    use_mock: useMock,
    max_iterations: parseInt(document.getElementById('cfgIter').value),
    ideas_per_provider: parseInt(document.getElementById('cfgIdeas').value),
    sector_focus: document.getElementById('cfgSector').value.trim(),
    concurrency: 1,
    retry_max: 3,
    models: {
      openai:    teamState.models[0],    // Slot 1 — locked OpenAI
      anthropic: teamState.models[1],    // Slot 2 — locked Anthropic
      deepseek:  teamState.models[2],    // Slot 3 — compat (configKey=deepseek)
      gemini:    teamState.models[3],    // Slot 4 — compat (configKey=gemini)
    },
    base_urls: {
      slot3: teamState.baseUrls[2] || '',  // server reads slot3 key first
      slot4: teamState.baseUrls[3] || '',  // server reads slot4 key first
    },
  };

  config.deliberation_enabled = document.getElementById('cfgDeliberation').checked;

  // Only send API keys in live mode
  if (!useMock) {
    config.api_keys = {
      OPENAI_API_KEY: document.getElementById('keyOpenai').value,
      ANTHROPIC_API_KEY: document.getElementById('keyAnthropic').value,
      OPENAI_COMPAT_API_KEY: document.getElementById('keyDeepseek').value,
      GEMINI_API_KEY: document.getElementById('keyGemini').value,
    };
  }

  try {
    const resp = await fetch('/api/runs', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(config),
    });
    const data = await resp.json();
    currentRunId = data.run_id;
    document.getElementById('runStatus').textContent = `Run ${data.run_id} started`;
  } catch (err) {
    btn.disabled = false;
    document.getElementById('runStatus').textContent = 'Failed to start: ' + err.message;
  }
}

async function loadRuns() {
  try {
    const resp = await fetch('/api/runs');
    const runs = await resp.json();
    const container = document.getElementById('runsList');
    if (!runs.length) {
      container.innerHTML = '<div class="empty"><h2>No runs yet</h2><p>Configure the control panel above and click "Launch Incubator".</p></div>';
      return;
    }
    let html = '<table><thead><tr><th>Run</th><th>Status</th><th>Mode</th><th>Sector</th><th>Events</th><th>Started</th><th></th></tr></thead><tbody>';
    for (const run of runs) {
      const started = run.started_at ? new Date(run.started_at * 1000).toLocaleString() : '-';
      const mode = run.config?.use_mock ? 'Mock' : 'Live';
      const sector = run.config?.sector_focus || 'All';
      const sc = run.status === 'complete' ? 'var(--green)' : run.status === 'error' ? 'var(--red)' : 'var(--yellow)';
      html += `<tr>
        <td style="font-weight:600">${run.run_id}</td>
        <td style="color:${sc}">${run.status}${run.error ? ': ' + run.error.substring(0,50) : ''}</td>
        <td>${mode}</td>
        <td>${sector}</td>
        <td>${run.event_count}</td>
        <td>${started}</td>
        <td>${run.status === 'complete' ? `<button class="secondary" onclick="loadResults('${run.run_id}')" style="padding:4px 12px;font-size:12px">View</button>` : ''}</td>
      </tr>`;
    }
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch(e) {}
}

async function loadResults(runId) {
  try {
    const resp = await fetch(`/api/runs/${runId}/results`);
    if (!resp.ok) return;
    const r = await resp.json();
    renderIdeas(r.stage1_ideas || []);
    renderPlans(r.stage2_final_plans || []);
    renderPitches(r.stage3_pitches || [], r.stage3_decisions || []);
    renderPortfolio(r.portfolio_report || []);
    loadRuns();
    // Switch to portfolio tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('[data-tab="portfolio"]').classList.add('active');
    document.getElementById('tab-portfolio').classList.add('active');
  } catch(e) {}
}

function renderIdeas(ideas) {
  const el = document.getElementById('ideasContent');
  if (!ideas.length) { el.innerHTML = '<div class="empty"><p>No ideas yet.</p></div>'; return; }
  let html = '<div class="card-grid">';
  for (const idea of ideas) {
    html += `<div class="card">
      <div class="provider">${idea.proposer_provider}</div>
      <h3>${esc(idea.title)}</h3>
      <p>${esc(idea.summary)}</p>
      <p><strong>Target:</strong> ${esc(idea.target_customer)}</p>
      <p><strong>Why now:</strong> ${esc(idea.why_now)}</p>
      <p><strong>Market:</strong> ${esc(idea.market_size_estimate)}</p>
      <p><strong>Moat:</strong> ${esc(idea.unfair_advantage)}</p>
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function renderPlans(plans) {
  const el = document.getElementById('plansContent');
  if (!plans.length) { el.innerHTML = '<div class="empty"><p>No plans yet.</p></div>'; return; }
  let html = '';
  for (const p of plans) {
    html += `<details>
      <summary><strong>${esc(p.founder_provider)}</strong> -- ${esc(p.idea_id)}</summary>
      <div class="content">
        <h4>Problem</h4><p>${esc(p.problem)}</p>
        <h4>Solution</h4><p>${esc(p.solution)}</p>
        <h4>Market</h4><p>TAM: ${esc(p.market?.tam)} | SAM: ${esc(p.market?.sam)} | SOM: ${esc(p.market?.som)}<br>Growth: ${esc(p.market?.growth_rate)}<br>${esc(p.market?.reasoning)}</p>
        <h4>Business Model</h4><p>${esc(p.business_model?.revenue_model)}<br>Pricing: ${esc(p.business_model?.pricing)}<br>Unit Economics: ${esc(p.business_model?.unit_economics)}</p>
        <h4>Go-to-Market</h4><p>${esc(p.go_to_market)}</p>
        <h4>Competitive Landscape</h4>
        ${(p.competitive_landscape||[]).map(c=>`<p><strong>${esc(c.competitor)}:</strong> Strength: ${esc(c.strength)} | Weakness: ${esc(c.weakness)} | Our edge: ${esc(c.our_advantage)}</p>`).join('')}
        <h4>Risks & Mitigations</h4>
        ${(p.risks_and_mitigations||[]).map(r=>`<p><span class="tag ${r.severity==='critical'||r.severity==='high'?'pass':'invest'}">${r.severity}</span> ${esc(r.risk)} -- ${esc(r.mitigation)}</p>`).join('')}
        <h4>12-Month Roadmap</h4><p>${esc(p.twelve_month_roadmap)}</p>
        <h4>Funding Ask</h4><p>${esc(p.funding_ask?.amount)}<br>Use: ${esc(p.funding_ask?.use_of_funds)}<br>Targets: ${esc(p.funding_ask?.target_metrics)}</p>
      </div>
    </details>`;
  }
  el.innerHTML = html;
}

function renderPitches(pitches, decisions) {
  const el = document.getElementById('pitchesContent');
  if (!pitches.length) { el.innerHTML = '<div class="empty"><p>No pitches yet.</p></div>'; return; }
  let html = '<div class="card-grid">';
  for (const pitch of pitches) {
    const dd = decisions.filter(d => d.idea_id === pitch.idea_id);
    const investN = dd.filter(d => d.decision === 'invest').length;
    html += `<div class="card">
      <div class="provider">${esc(pitch.founder_provider)}</div>
      <h3>${esc(pitch.elevator_pitch)}</h3>
      <p><strong>Problem/Solution:</strong> ${esc(pitch.problem_solution_fit?.substring(0,200))}...</p>
      <p><strong>The Ask:</strong> ${esc(pitch.the_ask)}</p>
      <p><strong>Why Now:</strong> ${esc(pitch.why_now)}</p>
      <p><strong>5yr Vision:</strong> ${esc(pitch.five_year_vision)}</p>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <strong>Investors: ${investN}/${dd.length} invest</strong>
        <div style="margin-top:8px">
          ${dd.map(d=>`<div style="margin:4px 0"><span class="tag ${d.decision}">${d.decision.toUpperCase()}</span> <strong>${esc(d.investor_provider)}</strong> (${d.conviction_score}/10)${d.proposed_terms?` -- ${esc(d.proposed_terms.check_size)} @ ${esc(d.proposed_terms.valuation_range)}`:''}${d.pass_reasons?` -- ${esc(d.pass_reasons.substring(0,100))}`:''}</div>`).join('')}
        </div>
      </div>
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function renderPortfolio(report) {
  const el = document.getElementById('portfolioContent');
  if (!report.length) { el.innerHTML = '<div class="empty"><p>No portfolio data yet.</p></div>'; return; }
  let html = '<table><thead><tr><th>Rank</th><th>Founder</th><th>Idea</th><th>Elevator Pitch</th><th>Investors</th><th>Conviction</th><th>Ask</th></tr></thead><tbody>';
  for (const row of report) {
    const cc = row.avg_conviction >= 7 ? 'var(--green)' : row.avg_conviction >= 5 ? 'var(--yellow)' : 'var(--red)';
    html += `<tr>
      <td style="font-size:20px;font-weight:700;color:var(--accent)">#${row.rank}</td>
      <td style="font-weight:600">${esc(row.founder)}</td>
      <td style="color:var(--muted)">${esc(row.idea_id)}</td>
      <td style="max-width:400px">${esc(row.elevator_pitch)}</td>
      <td><strong>${row.investors_in}</strong>/${row.investors_total}</td>
      <td style="color:${cc};font-weight:700;font-size:18px">${row.avg_conviction}</td>
      <td>${esc(row.funding_ask)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  el.innerHTML = html;
}

function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// Toggle API key fields based on mode
document.getElementById('cfgMock').addEventListener('change', (e) => {
  const keySection = document.querySelectorAll('#keyOpenai, #keyAnthropic, #keyDeepseek, #keyGemini');
  const isLive = e.target.value === 'false';
  keySection.forEach(el => { el.disabled = !isLive; el.style.opacity = isLive ? 1 : 0.4; });
});
// Initialize key fields as disabled (mock mode default)
document.querySelectorAll('#keyOpenai, #keyAnthropic, #keyDeepseek, #keyGemini').forEach(el => {
  el.disabled = true; el.style.opacity = 0.4;
});

connectWS();
loadRuns();
loadCatalog();
// Initialise team builder after DOM is ready
buildTeamUI();

// -- Model Catalog --
let _catalogData = [];
let _catalogFilter = 'all';

async function loadCatalog() {
  try {
    const resp = await fetch('/api/catalog');
    const data = await resp.json();
    _catalogData = data.catalog || [];
    renderCatalog();
  } catch(e) {
    document.getElementById('catalogContent').innerHTML = '<div class="empty"><p>Failed to load catalog.</p></div>';
  }
}

function filterCatalog(tier, btn) {
  _catalogFilter = tier;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderCatalog();
}

function renderCatalog() {
  const el = document.getElementById('catalogContent');
  const models = _catalogFilter === 'all' ? _catalogData : _catalogData.filter(m => m.tier === _catalogFilter);
  if (!models.length) { el.innerHTML = '<div class="empty"><p>No models found.</p></div>'; return; }
  let html = '<div class="catalog-grid">';
  for (const m of models) {
    const tier = m.tier || 'strong';
    const roles = (m.best_roles || []).map(r => `<span class="role-tag">${esc(r)}</span>`).join('');
    const strengths = (m.strengths || []).map(s => `<li>${esc(s)}</li>`).join('');
    const weaknesses = (m.weaknesses || []).map(w => `<li>${esc(w)}</li>`).join('');
    const ctx = m.context_window ? `<span style="font-size:11px;color:var(--muted)">Context: ${esc(String(m.context_window))}</span>` : '';
    html += `<div class="catalog-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
        <div>
          <div class="model-id">${esc(m.id)}</div>
          <div class="provider-name">${esc(m.provider)} &middot; ${esc(m.type || '')}</div>
        </div>
        <span class="tier-badge tier-${esc(tier)}">${esc(tier)}</span>
      </div>
      <div style="margin-bottom:8px">${roles} ${ctx}</div>
      <div class="pricing">
        <div class="price-item"><span class="price-label">Input / 1M</span><span class="price-val">$${m.pricing?.input ?? '?'}</span></div>
        <div class="price-item"><span class="price-label">Output / 1M</span><span class="price-val">$${m.pricing?.output ?? '?'}</span></div>
        <div class="price-item"><span class="price-label">Est. Run Cost</span><span class="price-val" id="est-${esc(m.id.replace(/[^a-z0-9]/gi,'_'))}">--</span></div>
      </div>
      ${strengths ? `<div style="font-size:11px;color:var(--accent);font-weight:600;margin-top:8px">STRENGTHS</div><ul>${strengths}</ul>` : ''}
      ${weaknesses ? `<div style="font-size:11px;color:var(--red);font-weight:600;margin-top:6px">WEAKNESSES</div><ul>${weaknesses}</ul>` : ''}
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
  // Fetch per-model cost estimates
  const ids = models.map(m => m.id);
  fetch('/api/estimate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({model_ids: ids}) })
    .then(r => r.json())
    .then(est => {
      for (const [id, info] of Object.entries(est.per_model || {})) {
        const key = id.replace(/[^a-z0-9]/gi,'_');
        const el2 = document.getElementById('est-' + key);
        if (el2) el2.textContent = '$' + info.estimated_cost_usd;
      }
    })
    .catch(() => {});
}

// -- Cost Estimator --
async function runEstimate() {
  const modelIds = [
    teamState.models[0],
    teamState.models[1],
    teamState.models[2],
    teamState.models[3],
  ];
  try {
    const resp = await fetch('/api/estimate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({model_ids: modelIds}),
    });
    const est = await resp.json();
    const box = document.getElementById('estimateResult');
    let rows = '';
    for (const [id, info] of Object.entries(est.per_model || {})) {
      rows += `<div class="estimate-row"><span>${esc(id)}</span><span style="font-weight:600">$${info.estimated_cost_usd}</span></div>`;
    }
    if (est.skipped_models?.length) {
      rows += `<div class="estimate-row" style="color:var(--muted)"><span>Not in catalog (skipped)</span><span>${est.skipped_models.join(', ')}</span></div>`;
    }
    box.style.display = 'block';
    box.innerHTML = `<div class="estimate-box">
      <div style="display:flex;justify-content:space-between;align-items:baseline">
        <div><div class="total">$${est.total_estimated_cost_usd}</div><div class="sub">Estimated total — ${(est.total_tokens/1000).toFixed(0)}K tokens across all models</div></div>
        <span style="font-size:11px;color:var(--muted)">Based on average call profiles</span>
      </div>
      <div style="margin-top:12px">${rows}</div>
    </div>`;
  } catch(e) {
    document.getElementById('estimateResult').innerHTML = '<div class="key-warning">Failed to fetch estimate.</div>';
    document.getElementById('estimateResult').style.display = 'block';
  }
}
</script>
</body>
</html>
