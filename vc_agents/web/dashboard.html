<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VC AI Incubator</title>
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d27; --border: #2a2d3a;
    --text: #e4e4e7; --muted: #8b8d97; --accent: #6366f1;
    --green: #22c55e; --red: #ef4444; --yellow: #eab308; --blue: #3b82f6;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
  .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

  /* Header */
  header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
  header h1 { font-size: 24px; font-weight: 700; }
  header h1 span { color: var(--accent); }
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
  .status-dot.connected { background: var(--green); }
  .status-dot.disconnected { background: var(--red); }

  /* Controls */
  .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 24px; flex-wrap: wrap; }
  button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500; transition: opacity .15s; }
  button:hover { opacity: .85; }
  button:disabled { opacity: .4; cursor: not-allowed; }
  button.secondary { background: var(--surface); border: 1px solid var(--border); }
  select, input { background: var(--surface); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; font-size: 14px; }
  label { font-size: 13px; color: var(--muted); }
  .control-group { display: flex; flex-direction: column; gap: 4px; }

  /* Tabs */
  .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
  .tab { padding: 10px 20px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; transition: all .15s; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Progress */
  .progress-bar { background: var(--surface); border-radius: 8px; overflow: hidden; height: 6px; margin: 16px 0; }
  .progress-fill { height: 100%; background: var(--accent); transition: width .3s; border-radius: 8px; }
  .stage-badges { display: flex; gap: 8px; margin-bottom: 16px; }
  .stage-badge { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: var(--surface); border: 1px solid var(--border); }
  .stage-badge.active { background: var(--accent); border-color: var(--accent); color: white; }
  .stage-badge.complete { background: rgba(34,197,94,.15); border-color: var(--green); color: var(--green); }

  /* Event log */
  .event-log { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; max-height: 300px; overflow-y: auto; padding: 12px; font-family: 'SF Mono', monospace; font-size: 12px; }
  .event-log .event { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,.04); }
  .event-log .event:last-child { border-bottom: none; }
  .event-log .ts { color: var(--muted); margin-right: 8px; }
  .event-log .type { color: var(--accent); margin-right: 8px; font-weight: 500; }

  /* Cards */
  .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: border-color .15s; }
  .card:hover { border-color: var(--accent); }
  .card h3 { font-size: 16px; margin-bottom: 8px; }
  .card .provider { font-size: 12px; color: var(--accent); font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
  .card p { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
  .card .score { font-size: 28px; font-weight: 700; }
  .card .score.high { color: var(--green); }
  .card .score.mid { color: var(--yellow); }
  .card .score.low { color: var(--red); }
  .card .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 4px; }
  .tag.invest { background: rgba(34,197,94,.15); color: var(--green); }
  .tag.pass { background: rgba(239,68,68,.15); color: var(--red); }

  /* Table */
  table { width: 100%; border-collapse: collapse; }
  th, td { text-align: left; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; }
  th { color: var(--muted); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
  tr:hover td { background: rgba(99,102,241,.05); }

  /* Expandable sections */
  details { margin-bottom: 12px; }
  summary { cursor: pointer; padding: 8px 0; font-weight: 500; color: var(--text); }
  summary:hover { color: var(--accent); }
  details .content { padding: 12px; background: var(--surface); border-radius: 8px; margin-top: 8px; font-size: 13px; }

  /* Empty state */
  .empty { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty h2 { font-size: 20px; margin-bottom: 8px; color: var(--text); }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>VC</span> AI Incubator</h1>
    <div id="wsStatus"><span class="status-dot disconnected"></span> Disconnected</div>
  </header>

  <div class="controls">
    <button id="btnRun" onclick="startRun()">Launch Pipeline</button>
    <div class="control-group">
      <label>Mode</label>
      <select id="cfgMock"><option value="true" selected>Mock (no API keys)</option><option value="false">Live (real APIs)</option></select>
    </div>
    <div class="control-group">
      <label>Iterations</label>
      <select id="cfgIter"><option>1</option><option>2</option><option selected>3</option></select>
    </div>
    <div class="control-group">
      <label>Ideas/Provider</label>
      <select id="cfgIdeas"><option>3</option><option selected>5</option><option>7</option></select>
    </div>
    <button class="secondary" onclick="loadRuns()">Refresh Runs</button>
  </div>

  <div id="activeRun" style="display:none">
    <div class="stage-badges" id="stageBadges">
      <div class="stage-badge" data-stage="stage1">Stage 1: Ideate</div>
      <div class="stage-badge" data-stage="stage2">Stage 2: Build</div>
      <div class="stage-badge" data-stage="stage3">Stage 3: Pitch</div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="event-log" id="eventLog"></div>
  </div>

  <div class="tabs" id="mainTabs">
    <div class="tab active" data-tab="runs">Runs</div>
    <div class="tab" data-tab="ideas">Ideas</div>
    <div class="tab" data-tab="plans">Plans</div>
    <div class="tab" data-tab="pitches">Pitches</div>
    <div class="tab" data-tab="portfolio">Portfolio</div>
  </div>

  <div class="tab-content active" id="tab-runs">
    <div id="runsList" class="empty"><h2>No runs yet</h2><p>Click "Launch Pipeline" to start your first incubator run.</p></div>
  </div>
  <div class="tab-content" id="tab-ideas"><div id="ideasContent" class="empty"><p>Run a pipeline to see ideas here.</p></div></div>
  <div class="tab-content" id="tab-plans"><div id="plansContent" class="empty"><p>Run a pipeline to see startup plans here.</p></div></div>
  <div class="tab-content" id="tab-pitches"><div id="pitchesContent" class="empty"><p>Run a pipeline to see pitches here.</p></div></div>
  <div class="tab-content" id="tab-portfolio"><div id="portfolioContent" class="empty"><p>Run a pipeline to see the portfolio report here.</p></div></div>
</div>

<script>
// -- State --
let ws = null;
let currentRunId = null;
let eventCount = 0;

// -- WebSocket --
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    document.getElementById('wsStatus').innerHTML = '<span class="status-dot connected"></span> Connected';
  };
  ws.onclose = () => {
    document.getElementById('wsStatus').innerHTML = '<span class="status-dot disconnected"></span> Disconnected';
    setTimeout(connectWS, 2000);
  };
  ws.onmessage = (e) => {
    const event = JSON.parse(e.data);
    if (event.type === 'pong') return;
    handleEvent(event);
  };
}

function handleEvent(event) {
  eventCount++;
  const log = document.getElementById('eventLog');
  const activeRun = document.getElementById('activeRun');
  activeRun.style.display = 'block';

  // Update stage badges
  if (event.type === 'stage_start') {
    document.querySelectorAll('.stage-badge').forEach(b => b.classList.remove('active'));
    const badge = document.querySelector(`[data-stage="${event.stage}"]`);
    if (badge) badge.classList.add('active');
  }
  if (event.type === 'stage_complete') {
    const badge = document.querySelector(`[data-stage="${event.stage}"]`);
    if (badge) { badge.classList.remove('active'); badge.classList.add('complete'); }
  }

  // Progress bar
  const stageProgress = { stage1: 33, stage2: 66, stage3: 100 };
  if (event.stage && stageProgress[event.stage]) {
    const base = event.type.includes('complete') ? stageProgress[event.stage] : stageProgress[event.stage] - 20;
    document.getElementById('progressFill').style.width = base + '%';
  }
  if (event.type === 'pipeline_complete') {
    document.getElementById('progressFill').style.width = '100%';
    document.getElementById('btnRun').disabled = false;
    if (currentRunId) loadResults(currentRunId);
  }
  if (event.type === 'pipeline_error') {
    document.getElementById('btnRun').disabled = false;
  }

  // Log entry
  const ts = new Date(event.timestamp * 1000).toLocaleTimeString();
  const div = document.createElement('div');
  div.className = 'event';
  div.innerHTML = `<span class="ts">${ts}</span><span class="type">${event.type}</span>${event.message || ''}${event.provider ? ' <span style="color:var(--blue)">[' + event.provider + ']</span>' : ''}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// -- API calls --
async function startRun() {
  const btn = document.getElementById('btnRun');
  btn.disabled = true;
  eventCount = 0;

  // Reset UI
  document.querySelectorAll('.stage-badge').forEach(b => { b.classList.remove('active', 'complete'); });
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('eventLog').innerHTML = '';
  document.getElementById('activeRun').style.display = 'block';

  const config = {
    use_mock: document.getElementById('cfgMock').value === 'true',
    max_iterations: parseInt(document.getElementById('cfgIter').value),
    ideas_per_provider: parseInt(document.getElementById('cfgIdeas').value),
    concurrency: 1,
    retry_max: 3,
  };

  const resp = await fetch('/api/runs', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(config) });
  const data = await resp.json();
  currentRunId = data.run_id;
}

async function loadRuns() {
  const resp = await fetch('/api/runs');
  const runs = await resp.json();
  const container = document.getElementById('runsList');

  if (!runs.length) {
    container.innerHTML = '<div class="empty"><h2>No runs yet</h2><p>Click "Launch Pipeline" to start.</p></div>';
    return;
  }

  let html = '<table><thead><tr><th>Run ID</th><th>Status</th><th>Mode</th><th>Events</th><th>Started</th><th>Actions</th></tr></thead><tbody>';
  for (const run of runs) {
    const started = run.started_at ? new Date(run.started_at * 1000).toLocaleString() : '-';
    const mode = run.config?.use_mock ? 'Mock' : 'Live';
    const statusColor = run.status === 'complete' ? 'var(--green)' : run.status === 'error' ? 'var(--red)' : 'var(--yellow)';
    html += `<tr>
      <td>${run.run_id}</td>
      <td style="color:${statusColor}">${run.status}</td>
      <td>${mode}</td>
      <td>${run.event_count}</td>
      <td>${started}</td>
      <td>${run.status === 'complete' ? `<button class="secondary" onclick="loadResults('${run.run_id}')" style="padding:4px 12px;font-size:12px">View Results</button>` : ''}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

async function loadResults(runId) {
  const resp = await fetch(`/api/runs/${runId}/results`);
  if (!resp.ok) return;
  const results = await resp.json();
  renderIdeas(results.stage1_ideas || []);
  renderPlans(results.stage2_final_plans || []);
  renderPitches(results.stage3_pitches || [], results.stage3_decisions || []);
  renderPortfolio(results.portfolio_report || []);
  loadRuns();
}

// -- Renderers --
function renderIdeas(ideas) {
  const el = document.getElementById('ideasContent');
  if (!ideas.length) { el.innerHTML = '<div class="empty"><p>No ideas yet.</p></div>'; return; }
  let html = '<div class="card-grid">';
  for (const idea of ideas) {
    html += `<div class="card">
      <div class="provider">${idea.proposer_provider}</div>
      <h3>${idea.title}</h3>
      <p>${idea.summary}</p>
      <p><strong>Target:</strong> ${idea.target_customer}</p>
      <p><strong>Why now:</strong> ${idea.why_now}</p>
      <p><strong>Market:</strong> ${idea.market_size_estimate}</p>
      <p><strong>Moat:</strong> ${idea.unfair_advantage}</p>
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function renderPlans(plans) {
  const el = document.getElementById('plansContent');
  if (!plans.length) { el.innerHTML = '<div class="empty"><p>No plans yet.</p></div>'; return; }
  let html = '';
  for (const plan of plans) {
    html += `<details>
      <summary><strong>${plan.founder_provider}</strong> -- ${plan.idea_id}</summary>
      <div class="content">
        <h4>Problem</h4><p>${plan.problem}</p>
        <h4>Solution</h4><p>${plan.solution}</p>
        <h4>Market</h4><p>TAM: ${plan.market?.tam} | SAM: ${plan.market?.sam} | SOM: ${plan.market?.som}</p>
        <h4>Business Model</h4><p>${plan.business_model?.revenue_model} -- ${plan.business_model?.pricing}</p>
        <h4>Go-to-Market</h4><p>${plan.go_to_market}</p>
        <h4>Competitive Landscape</h4>
        ${(plan.competitive_landscape || []).map(c => `<p><strong>${c.competitor}:</strong> ${c.our_advantage}</p>`).join('')}
        <h4>Risks</h4>
        ${(plan.risks_and_mitigations || []).map(r => `<p><span class="tag ${r.severity === 'critical' ? 'pass' : 'invest'}">${r.severity}</span> ${r.risk} -- ${r.mitigation}</p>`).join('')}
        <h4>Funding Ask</h4><p>${plan.funding_ask?.amount} -- ${plan.funding_ask?.use_of_funds}</p>
      </div>
    </details>`;
  }
  el.innerHTML = html;
}

function renderPitches(pitches, decisions) {
  const el = document.getElementById('pitchesContent');
  if (!pitches.length) { el.innerHTML = '<div class="empty"><p>No pitches yet.</p></div>'; return; }
  let html = '<div class="card-grid">';
  for (const pitch of pitches) {
    const ideaDecisions = decisions.filter(d => d.idea_id === pitch.idea_id);
    const investCount = ideaDecisions.filter(d => d.decision === 'invest').length;
    html += `<div class="card">
      <div class="provider">${pitch.founder_provider}</div>
      <h3>${pitch.elevator_pitch}</h3>
      <p><strong>The Ask:</strong> ${pitch.the_ask}</p>
      <p><strong>Why Now:</strong> ${pitch.why_now}</p>
      <p><strong>Vision:</strong> ${pitch.five_year_vision}</p>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <strong>Investor Decisions:</strong> ${investCount}/${ideaDecisions.length} invest
        <div style="margin-top:8px">
          ${ideaDecisions.map(d => `<span class="tag ${d.decision}">${d.investor_provider}: ${d.decision} (${d.conviction_score}/10)</span> `).join('')}
        </div>
      </div>
    </div>`;
  }
  html += '</div>';
  el.innerHTML = html;
}

function renderPortfolio(report) {
  const el = document.getElementById('portfolioContent');
  if (!report.length) { el.innerHTML = '<div class="empty"><p>No portfolio data yet.</p></div>'; return; }
  let html = '<table><thead><tr><th>Rank</th><th>Founder</th><th>Idea</th><th>Elevator Pitch</th><th>Investors In</th><th>Avg Conviction</th><th>Funding Ask</th></tr></thead><tbody>';
  for (const row of report) {
    const convColor = row.avg_conviction >= 7 ? 'var(--green)' : row.avg_conviction >= 5 ? 'var(--yellow)' : 'var(--red)';
    html += `<tr>
      <td><strong>#${row.rank}</strong></td>
      <td>${row.founder}</td>
      <td>${row.idea_id}</td>
      <td style="max-width:400px">${row.elevator_pitch}</td>
      <td>${row.investors_in}/${row.investors_total}</td>
      <td style="color:${convColor};font-weight:700">${row.avg_conviction}</td>
      <td>${row.funding_ask}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  el.innerHTML = html;
}

// -- Tabs --
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// -- Init --
connectWS();
loadRuns();
</script>
</body>
</html>
