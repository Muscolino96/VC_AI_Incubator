---
phase: 01-backend-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vc_agents/web/server.py
  - vc_agents/pipeline/run.py
autonomous: true
requirements:
  - BUG-01
  - BUG-02

must_haves:
  truths:
    - "server.py imports _load_jsonl so any checkpoint resume path in the HTTP layer resolves without NameError"
    - "checkpoint resume after Stage 2 loads final_plans keyed by idea_id so Stage 3 can iterate by founder.name without KeyError"
    - "checkpoint resume after Stage 1 loads selections keyed by idea_id so Stage 2 can look up selections without KeyError"
  artifacts:
    - path: "vc_agents/web/server.py"
      provides: "_load_jsonl import from vc_agents.pipeline.run"
      contains: "from vc_agents.pipeline.run import _load_jsonl"
    - path: "vc_agents/pipeline/run.py"
      provides: "checkpoint resume keys final_plans by idea_id"
      contains: 'p["idea_id"]: p for p in plans_list'
  key_links:
    - from: "vc_agents/web/server.py"
      to: "vc_agents/pipeline/run._load_jsonl"
      via: "import statement at top of file"
      pattern: "from vc_agents.pipeline.run import _load_jsonl"
    - from: "vc_agents/pipeline/run.run_pipeline (checkpoint path)"
      to: "run_stage3 final_plans lookup"
      via: "idea_id key instead of founder_provider key"
      pattern: 'p\["idea_id"\]: p'
---

<objective>
Fix the two crash-on-resume bugs: import the missing `_load_jsonl` symbol in server.py (BUG-01) and rekey the checkpoint-loaded dicts in run.py from `founder_provider` to `idea_id` (BUG-02).

Purpose: These are latent crashes that surface only on checkpoint resume paths. After this plan, a user can kill the server mid-pipeline and resume without NameError or KeyError.
Output: Two modified files with targeted one- to three-line fixes each.
</objective>

<execution_context>
@C:/Users/Vince/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Vince/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<interfaces>
<!-- Key code sections the executor must understand before editing. -->

From vc_agents/web/server.py (current imports, lines 9-27):
```python
from __future__ import annotations

import asyncio
import json
import os
import threading
import time
import uuid
from pathlib import Path
from typing import Any

from dotenv import load_dotenv
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.responses import HTMLResponse, JSONResponse

from vc_agents.logging_config import setup_logging
from vc_agents.pipeline.cost_estimator import estimate_cost, load_catalog
from vc_agents.pipeline.events import EventCallback, PipelineEvent
from vc_agents.pipeline.run import run_pipeline
```

From vc_agents/pipeline/run.py (checkpoint resume section, lines 816-837):
```python
        # Stage 1: Ideate and Select
        if checkpoint and checkpoint.get("stage1_complete"):
            logger.info("Resuming: loading Stage 1 selections from checkpoint")
            selections_list = _load_jsonl(run_dir / "stage1_selections.jsonl")
            selections = {s["founder_provider"]: s for s in selections_list}
        else:
            selections = run_stage1(...)
            _save_checkpoint(run_dir, {"stage1_complete": True})

        # Stage 2: Build and Iterate
        if checkpoint and checkpoint.get("stage2_complete"):
            logger.info("Resuming: loading Stage 2 plans from checkpoint")
            plans_list = _load_jsonl(run_dir / "stage2_final_plans.jsonl")
            final_plans = {p["founder_provider"]: p for p in plans_list}
        else:
            final_plans = run_stage2(...)
            _save_checkpoint(run_dir, {"stage1_complete": True, "stage2_complete": True})
```

From vc_agents/pipeline/run.py (Stage 3 lookup, line 664):
```python
    for founder in founders_list:
        plan = final_plans[founder.name]   # KeyError if keyed by founder_provider not idea_id
```

From vc_agents/pipeline/run.py (_load_jsonl definition, lines 270-278):
```python
def _load_jsonl(path: Path) -> list[dict[str, Any]]:
    """Load records from a JSONL file."""
    records: list[dict[str, Any]] = []
    with path.open(encoding="utf-8") as f:
        for line in f:
            line = line.strip()
            if line:
                records.append(json.loads(line))
    return records
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add _load_jsonl import to server.py (BUG-01)</name>
  <files>vc_agents/web/server.py</files>
  <action>
    In `vc_agents/web/server.py`, extend the existing `from vc_agents.pipeline.run import run_pipeline` line (line 27) to also import `_load_jsonl`. Change it to:

    ```python
    from vc_agents.pipeline.run import _load_jsonl, run_pipeline
    ```

    No other changes to server.py in this task. The spec's Option A (minimal) is correct — do NOT create a shared utils module (that is Option B and is out of scope for this fix).

    Keep import alphabetical within the `from vc_agents.pipeline.run import` statement: `_load_jsonl` comes before `run_pipeline`.
  </action>
  <verify>
    <automated>cd C:/Users/Vince/Desktop/VC_AI_Incubator-main && python -c "from vc_agents.web.server import app; print('import OK')"</automated>
  </verify>
  <done>Running `python -c "from vc_agents.web.server import app"` exits 0 with no NameError or ImportError. The import line contains both `_load_jsonl` and `run_pipeline`.</done>
</task>

<task type="auto">
  <name>Task 2: Rekey checkpoint dicts by idea_id in run.py (BUG-02)</name>
  <files>vc_agents/pipeline/run.py</files>
  <action>
    In `vc_agents/pipeline/run.py`, inside `run_pipeline()`, find the two checkpoint-resume loading blocks and change the dict-comprehension keys from `founder_provider` to `idea_id`.

    **Change 1 — Stage 1 selections resume (around line 819):**
    ```python
    # BEFORE
    selections = {s["founder_provider"]: s for s in selections_list}
    # AFTER
    selections = {s["idea_id"]: s for s in selections_list}
    ```

    **Change 2 — Stage 2 final_plans resume (around line 831):**
    ```python
    # BEFORE
    final_plans = {p["founder_provider"]: p for p in plans_list}
    # AFTER
    final_plans = {p["idea_id"]: p for p in plans_list}
    ```

    These are the ONLY two lines to change. Do not touch Stage 3's `final_plans[founder.name]` lookup (line 664) — Stage 3 already uses `founder.name` against what `run_stage2` returns in the non-resume path, which is keyed by `founder.name`. The checkpoint resume path is the only place that was previously keyed wrong.

    Note per STATE.md decisions: "Rekey `final_plans` by `idea_id` (not defensive fallback) — eliminates key mismatch class of bugs permanently". Do NOT use the defensive `.get()` fallback from the spec's alternative option.

    Also verify that `stage1_selections.jsonl` records contain an `idea_id` field (they do — `run_stage1` returns `selections` keyed by provider name, each value is a `SELECTION_SCHEMA` result which includes `selected_idea_id` and a `refined_idea` that has `idea_id`). For selections, the correct key is `s["refined_idea"]["idea_id"]` — check the actual schema before writing the change.

    Looking at run_stage1 line 438-441:
    ```python
    selections[provider.name] = result  # result is SELECTION_SCHEMA
    ```
    And the JSONL is written as `list(selections.values())`. Each `result` has `selected_idea_id` and `refined_idea: {idea_id: ...}`. Use `s["refined_idea"]["idea_id"]` for selections keying, and `p["idea_id"]` for final_plans keying (startup plan has top-level `idea_id`).
  </action>
  <verify>
    <automated>cd C:/Users/Vince/Desktop/VC_AI_Incubator-main && python -c "from vc_agents.pipeline.run import run_pipeline; print('import OK')"</automated>
  </verify>
  <done>
    Both checkpoint dict comprehensions use `idea_id`-based keys (not `founder_provider`). The module imports without error. A grep confirms no remaining `founder_provider` key lookups in the checkpoint resume section of `run_pipeline`.
  </done>
</task>

</tasks>

<verification>
After both tasks:
- `python -c "from vc_agents.web.server import app"` exits 0
- `python -c "from vc_agents.pipeline.run import run_pipeline"` exits 0
- `grep "founder_provider" vc_agents/pipeline/run.py` returns 0 matches in the checkpoint resume section
- `grep "_load_jsonl" vc_agents/web/server.py` shows the import line
</verification>

<success_criteria>
1. `server.py` imports `_load_jsonl` alongside `run_pipeline` — NameError on checkpoint resume path is eliminated
2. Both checkpoint-loaded dicts in `run_pipeline` are keyed by `idea_id` (via `refined_idea.idea_id` for selections, direct `idea_id` for plans) — KeyError on Stage 3 resume is eliminated regardless of founder name vs provider name
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-fixes/01-01-SUMMARY.md` using the summary template.
</output>
