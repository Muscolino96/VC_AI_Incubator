---
phase: 05-new-dashboard
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - vc_agents/web/dashboard.html
autonomous: true
requirements:
  - DASH-03
  - DASH-04
  - DASH-05

must_haves:
  truths:
    - "The Ideas tab shows a Feedback sub-section beneath each idea card with reviewer scores and comments from Stage 1"
    - "The run results view shows a token usage summary with per-provider input/output token counts and estimated cost"
    - "The Plans tab shows deliberation summaries (consensus issues, disagreements, priority actions) under each founder's plan when deliberation JSONL files are present in the results"
  artifacts:
    - path: "vc_agents/web/dashboard.html"
      provides: "renderFeedback(), renderTokenUsage(), deliberation section in renderPlans()"
      contains: "renderFeedback"
  key_links:
    - from: "loadResults()"
      to: "renderFeedback(r.stage1_feedback)"
      via: "r object from /api/runs/{id}/results"
      pattern: "renderFeedback"
    - from: "loadResults()"
      to: "renderTokenUsage(r.token_usage)"
      via: "r object from /api/runs/{id}/results"
      pattern: "renderTokenUsage"
    - from: "renderPlans()"
      to: "deliberation JSONL keys in results"
      via: "Object.keys(r).filter pattern"
      pattern: "deliberation_round"
---

<objective>
Add the three missing features to the deployed dashboard: feedback display in the Ideas tab, token usage summary in the results view, and deliberation summaries in the Plans tab.

Purpose: The new dashboard (deployed in Plan 01) has Ideas/Plans/Pitches/Portfolio tabs but no rendering for Stage 1 feedback scores, token usage, or deliberation results. These are required by DASH-03, DASH-04, DASH-05.

Output: dashboard.html augmented with renderFeedback(), renderTokenUsage(), and deliberation rendering inside renderPlans(). loadResults() updated to call these new functions. CSS styles for feedback badges and token usage grid added to the existing style block.
</objective>

<execution_context>
@C:/Users/Vince/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Vince/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-new-dashboard/05-01-SUMMARY.md
@vc_agents/web/dashboard.html

**CRITICAL PROJECT RULE (from CLAUDE.md):** Do NOT simplify, flatten, or "clean up" the CSS/JS. All additions must match the existing design system precisely — use the established CSS tokens (--gold, --surface, --font-mono, --font-serif, --text-dim, etc.) and the existing card/badge/table patterns. New CSS must be appended to the existing style block, not replacing anything.

**Data contract — what the results API returns:**

stage1_feedback key (array of objects from stage1_feedback.jsonl):
```json
[
  {
    "idea_id": "openai_idea_1",
    "reviewer_provider": "anthropic",
    "score": 7,
    "summary": "Strong market timing...",
    "strengths": ["..."],
    "weaknesses": ["..."],
    "questions": ["..."]
  }
]
```

token_usage key (object, from token_usage.json — served by Plan 01 patch):
```json
{
  "openai":    { "input_tokens": 12340, "output_tokens": 56780 },
  "anthropic": { "input_tokens": 23450, "output_tokens": 67890 },
  "deepseek":  { "input_tokens": 34560, "output_tokens": 78900 },
  "gemini":    { "input_tokens": 45670, "output_tokens": 89010 }
}
```

deliberation keys — results object contains keys matching pattern `stage2_{provider}_deliberation_round{n}`:
```json
{
  "stage2_openai_deliberation_round1": [
    {
      "overall_readiness": true,
      "avg_score": 7.3,
      "consensus_issues": ["..."],
      "key_disagreements": ["..."],
      "priority_actions": ["..."],
      "recommended_focus": "..."
    }
  ]
}
```

**Existing patterns to follow in dashboard.html:**
- CSS tokens: --gold, --surface, --surface-2, --border, --border-hi, --text, --text-dim, --text-xs, --font-mono, --font-serif, --font-sans, --r, --r-lg, --green, --red, --yellow
- Card class: `.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-lg); padding: 22px; }`
- Section label: `.section-label { font-family: var(--font-mono); font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--gold); }`
- Provider badge: `.provider-badge { font-family: var(--font-mono); font-size: 9px; ... }`
- Plan accordion: `details.plan-item`, `.plan-body`, `.plan-sec`, `.plan-sec.full`
- Empty state: `emptyState(icon, title, desc)` helper function
- Escape: `esc(s)` helper function for HTML escaping
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add feedback CSS and renderFeedback() function</name>
  <files>vc_agents/web/dashboard.html</files>
  <action>
    Make two additions to vc_agents/web/dashboard.html. Read the file first.

    **Addition 1 — CSS (append to the existing style block, before the closing `</style>` tag):**

    ```css
    /* ─────────────────────────── FEEDBACK ─────────────────────────── */
    .feedback-section { margin-top: 28px; }
    .feedback-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 12px; margin-top: 14px; }
    .feedback-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 15px; }
    .feedback-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 10px; }
    .feedback-idea-id { font-family: var(--font-mono); font-size: 10px; color: var(--text-xs); }
    .feedback-score { font-family: var(--font-serif); font-size: 22px; }
    .feedback-reviewer { margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .feedback-summary { font-size: 12px; color: var(--text-dim); line-height: 1.55; margin-bottom: 8px; }
    .feedback-list { display: flex; flex-direction: column; gap: 4px; }
    .feedback-list-item { font-size: 11px; color: var(--text-dim); display: flex; gap: 6px; }
    .feedback-list-item::before { content: '·'; color: var(--gold); flex-shrink: 0; }
    .feedback-subsection-label { font-family: var(--font-mono); font-size: 9px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: var(--text-xs); margin-bottom: 4px; }

    /* ─────────────────────────── TOKEN USAGE ─────────────────────────── */
    .token-section { margin-top: 28px; }
    .token-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 14px; }
    .token-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 14px 16px; }
    .token-provider { font-family: var(--font-mono); font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
    .token-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
    .token-label { font-size: 11px; color: var(--text-xs); }
    .token-val { font-family: var(--font-mono); font-size: 12px; color: var(--text-dim); }
    .token-total { font-family: var(--font-mono); font-size: 13px; color: var(--text); font-weight: 500; border-top: 1px solid var(--border); margin-top: 6px; padding-top: 6px; }
    ```

    **Addition 2 — JavaScript (add these two functions before the `/* ══════════════════ INIT ══════════════════ */` comment):**

    ```js
    /* ══════════════════ RENDER FEEDBACK ══════════════════ */
    function renderFeedback(feedback) {
      const el = document.getElementById('ideasContent');
      if (!feedback || !feedback.length) return; // ideas already rendered; feedback is additive
      // Group feedback by idea_id
      const byIdea = {};
      for (const fb of feedback) {
        const key = fb.idea_id || 'unknown';
        if (!byIdea[key]) byIdea[key] = [];
        byIdea[key].push(fb);
      }
      // Append feedback section after existing idea grid
      const div = document.createElement('div');
      div.className = 'feedback-section';
      let html = '<div class="section-label" style="margin-bottom:14px">Stage 1 Reviewer Feedback</div><div class="feedback-grid">';
      for (const [ideaId, reviews] of Object.entries(byIdea)) {
        const avgScore = reviews.length
          ? (reviews.reduce((s, r) => s + (r.score || 0), 0) / reviews.length).toFixed(1)
          : '—';
        const scoreColor = parseFloat(avgScore) >= 7 ? 'var(--green)' : parseFloat(avgScore) >= 5 ? 'var(--yellow)' : 'var(--red)';
        for (const fb of reviews) {
          const prov = (fb.reviewer_provider || '').toLowerCase();
          const strengths = (fb.strengths || []).slice(0, 2).map(s => `<div class="feedback-list-item">${esc(s)}</div>`).join('');
          const weaknesses = (fb.weaknesses || []).slice(0, 2).map(w => `<div class="feedback-list-item">${esc(w)}</div>`).join('');
          html += `<div class="feedback-card">
            <div class="feedback-header">
              <div>
                <div class="feedback-idea-id">${esc(ideaId)}</div>
                <div class="feedback-reviewer"><span class="provider-badge ${prov}">${esc(fb.reviewer_provider)}</span></div>
              </div>
              <div class="feedback-score" style="color:${scoreColor}">${fb.score ?? '—'}/10</div>
            </div>
            <div class="feedback-summary">${esc(fb.summary)}</div>
            ${strengths ? `<div class="feedback-subsection-label">Strengths</div><div class="feedback-list">${strengths}</div>` : ''}
            ${weaknesses ? `<div class="feedback-subsection-label" style="margin-top:6px">Weaknesses</div><div class="feedback-list">${weaknesses}</div>` : ''}
          </div>`;
        }
      }
      html += '</div>';
      div.innerHTML = html;
      el.appendChild(div);
    }

    /* ══════════════════ RENDER TOKEN USAGE ══════════════════ */
    function renderTokenUsage(usage) {
      if (!usage || !Object.keys(usage).length) return;
      // Append token usage section after portfolio content
      const portfolioEl = document.getElementById('portfolioContent');
      if (!portfolioEl) return;
      const div = document.createElement('div');
      div.className = 'token-section';
      let html = '<div class="section-label" style="margin-bottom:14px">Token Usage</div><div class="token-grid">';
      for (const [prov, data] of Object.entries(usage)) {
        const input = (data.input_tokens || 0).toLocaleString();
        const output = (data.output_tokens || 0).toLocaleString();
        const total = ((data.input_tokens || 0) + (data.output_tokens || 0)).toLocaleString();
        const provClass = prov.toLowerCase();
        html += `<div class="token-card">
          <div class="token-provider" style="color:var(--c-${provClass}, var(--text-dim))">${esc(prov)}</div>
          <div class="token-row"><span class="token-label">Input</span><span class="token-val">${input}</span></div>
          <div class="token-row"><span class="token-label">Output</span><span class="token-val">${output}</span></div>
          <div class="token-total">${total} total</div>
        </div>`;
      }
      html += '</div>';
      div.innerHTML = html;
      portfolioEl.appendChild(div);
    }
    ```

    **Addition 3 — Update loadResults() to call the new functions:**

    Find the existing `loadResults` function. It currently ends with:
    ```js
        renderPortfolio(r.portfolio_report || []);
        switchTab('portfolio');
    ```

    Change it to:
    ```js
        renderPortfolio(r.portfolio_report || []);
        renderFeedback(r.stage1_feedback || []);
        renderTokenUsage(r.token_usage || {});
        switchTab('portfolio');
    ```

    Do NOT change anything else in loadResults().

    **Addition 4 — Deliberation summaries in renderPlans():**

    The renderPlans() function takes a `plans` array. Change its signature to accept a second parameter `allResults` containing the full results object:

    Change `function renderPlans(plans) {` to `function renderPlans(plans, allResults) {`

    Then, inside the `for (const p of plans)` loop, after the closing `</div>` of `.plan-body` but before the closing `</details>`, add a deliberation block:

    ```js
    // Deliberation summaries for this founder
    const founderName = (p.founder_provider || '').toLowerCase();
    const deliberationKeys = allResults
      ? Object.keys(allResults).filter(k => k.startsWith(`stage2_${founderName}_deliberation_round`))
      : [];
    let deliberationHtml = '';
    if (deliberationKeys.length) {
      deliberationHtml = `<div class="plan-body" style="border-top:1px solid var(--border);padding-top:16px">
        <div class="plan-sec full">
          <h4>Deliberation Rounds</h4>
          ${deliberationKeys.sort().map(key => {
            const rounds = allResults[key] || [];
            return rounds.map(d => `
              <div style="background:var(--ink-2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:8px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                  <span style="font-family:var(--font-mono);font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text-xs)">${esc(key.replace('stage2_','').replace(/_/g,' '))}</span>
                  <span style="font-family:var(--font-mono);font-size:12px;color:${d.overall_readiness ? 'var(--green)' : 'var(--yellow)'}">${d.avg_score ? d.avg_score.toFixed(1) + '/10' : ''} ${d.overall_readiness ? '✓ ready' : '— iterating'}</span>
                </div>
                ${(d.consensus_issues || []).length ? `<div style="font-family:var(--font-mono);font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text-xs);margin-bottom:4px">Consensus issues</div>${(d.consensus_issues||[]).map(i => `<div style="font-size:11px;color:var(--text-dim);margin-bottom:2px">· ${esc(i)}</div>`).join('')}` : ''}
                ${(d.priority_actions || []).length ? `<div style="font-family:var(--font-mono);font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text-xs);margin-top:6px;margin-bottom:4px">Priority actions</div>${(d.priority_actions||[]).map(a => `<div style="font-size:11px;color:var(--text-dim);margin-bottom:2px">· ${esc(a)}</div>`).join('')}` : ''}
              </div>`).join('');
          }).join('')}
        </div>
      </div>`;
    }
    ```

    Then include `${deliberationHtml}` after the closing `</div>` of `.plan-body` in the template string.

    Update the renderPlans() call in loadResults() to pass the full results object:
    Change `renderPlans(r.stage2_final_plans || []);` to `renderPlans(r.stage2_final_plans || [], r);`

    CRITICAL: Do NOT change any other part of renderPlans(). Preserve all existing competitive landscape, risks, market, and other rendering logic exactly.
  </action>
  <verify>
    <automated>python -c "
content = open('vc_agents/web/dashboard.html', encoding='utf-8').read()
assert 'renderFeedback' in content, 'renderFeedback function missing'
assert 'renderTokenUsage' in content, 'renderTokenUsage function missing'
assert 'token-grid' in content, 'token-grid CSS class missing'
assert 'feedback-grid' in content, 'feedback-grid CSS class missing'
assert 'deliberation_round' in content, 'deliberation key filter missing'
assert 'renderFeedback(r.stage1_feedback' in content, 'loadResults not calling renderFeedback'
assert 'renderTokenUsage(r.token_usage' in content, 'loadResults not calling renderTokenUsage'
assert 'renderPlans(r.stage2_final_plans || [], r)' in content, 'renderPlans not receiving allResults'
assert 'SLOTS' in content, 'SLOTS array still present (no regression)'
assert 'wordmark-vc' in content, 'wordmark still present (no regression)'
print('All feature additions verified OK')
"
    </automated>
  </verify>
  <done>
    - Ideas tab appends a Feedback sub-section when stage1_feedback data is present
    - Portfolio view appends a Token Usage grid when token_usage data is present
    - Plans accordion shows Deliberation Rounds sections for founders that have deliberation JSONL files
    - All three functions are called from loadResults()
    - All existing rendering (ideas, plans, pitches, portfolio) still works unchanged
  </done>
</task>

</tasks>

<verification>
After task completion:
1. `pytest tests/ -v` — all tests pass (no server-side changes in this plan)
2. Verify the dashboard renders correctly with mock run data:
   - python -c "content = open('vc_agents/web/dashboard.html').read(); assert 'renderFeedback' in content"
3. Manual check with running server: Start a mock run, click View on the completed run, verify Ideas tab shows feedback cards and Portfolio tab shows token grid

Check for regressions:
- `python -c "import ast; ast.parse(open('vc_agents/web/dashboard.html').read())"` — will fail (HTML, not Python, this is expected — use the python assertion check above instead)
- The existing renderIdeas/renderPlans/renderPitches/renderPortfolio functions must remain intact
</verification>

<success_criteria>
- renderFeedback() function exists in dashboard.html, reads stage1_feedback array, groups by idea_id, renders reviewer badges + scores + summary + strengths/weaknesses
- renderTokenUsage() function exists, renders per-provider input/output/total token card grid
- renderPlans() accepts allResults as second argument, looks up stage2_{founder}_deliberation_round* keys, renders consensus issues and priority actions within each plan accordion
- loadResults() calls all three new functions
- pytest tests/ -v still passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-new-dashboard/05-02-SUMMARY.md` summarizing:
- What was added (function names, CSS classes)
- Verification results (pytest output, assertion check)
- Any deviations from plan or edge cases encountered
</output>
