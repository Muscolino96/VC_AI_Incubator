---
phase: 06-dynamic-provider-count
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - tests/test_pipeline.py
autonomous: true
requirements:
  - DYN-05

must_haves:
  truths:
    - "A 2-founder run (1 founder + 3 advisors/investors via roles_config) completes all three stages"
    - "A 6-provider run (6 mock providers, all-do-everything) completes all three stages"
    - "Review count for 2-founder config is len(advisors) - 1 = 2 per idea per round (advisor excludes self)"
    - "Review count for 6-provider config is len(providers) - 1 = 5 per idea per round"
    - "Advisor role rotation cycles through 3 roles correctly with more advisors than roles (6 providers)"
    - "Tests for 1-founder, 2-founder, and 6-provider configurations all pass"
  artifacts:
    - path: "tests/test_pipeline.py"
      provides: "TestDynamicProviderCount class with tests covering DYN-01 through DYN-05"
      contains: "TestDynamicProviderCount"
  key_links:
    - from: "tests/test_pipeline.py TestDynamicProviderCount"
      to: "vc_agents/pipeline/run.py run_pipeline"
      via: "mock_providers=[MockProvider(name) for name in ...]"
      pattern: "mock_providers"
---

<objective>
Add a `TestDynamicProviderCount` test class covering all configurations the spec requires: 2-founder (via roles_config), 6-provider (via mock_providers), review count correctness, and advisor role rotation. The 1-founder test already exists in `TestRoleAssignment.test_pipeline_with_single_founder` — this plan explicitly verifies it still passes and adds the missing configurations.

Purpose: DYN-05 requires tests for 1-founder, 2-founder, and 6-provider configurations. The `mock_providers` param added in Plan 01 is the mechanism for injecting 6 providers. The 2-founder test uses `roles_config` on the default 4-provider pool (same pattern as the existing 1-founder test).

Output: A new TestDynamicProviderCount class in tests/test_pipeline.py with 6 targeted tests.
</objective>

<execution_context>
@C:/Users/Vince/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Vince/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/06-dynamic-provider-count/06-01-SUMMARY.md
@vc_agents/pipeline/run.py
@tests/test_pipeline.py

<interfaces>
<!-- Contracts the executor needs to implement against. -->

From vc_agents/pipeline/run.py after Plan 01:
```python
def run_pipeline(
    use_mock: bool,
    concurrency: int,
    retry_max: int,
    max_iterations: int = 3,
    ideas_per_provider: int = 5,
    sector_focus: str = "",
    emit: EventCallback = noop_callback,
    provider_config: dict[str, Any] | None = None,
    resume_dir: Path | None = None,
    roles_config: dict[str, Any] | None = None,
    deliberation_enabled: bool = False,
    skip_preflight: bool = False,
    mock_providers: list[BaseProvider] | None = None,   # <-- added in Plan 01
    slot3_base_url: str = "...",
    slot4_base_url: str = "...",
) -> Path:
```

Existing 1-founder test (TestRoleAssignment.test_pipeline_with_single_founder, line 221):
Uses `roles_config={"founders": ["anthropic"], "advisors": [...3 providers...], "investors": [...3 providers...]}`.
Asserts: `len(ideas) == 5`, `len(feedback) == 15` (5 ideas * 3 advisors), `len(selections) == 1`, `len(decisions) == 3`.

MockProvider always returns 5 ideas regardless of `ideas_count` in the prompt.

ADVISOR_ROLES has exactly 3 entries. Role rotation formula: `ADVISOR_ROLES[(i + round_num - 1) % len(ADVISOR_ROLES)]`.
With 6 advisors and 1 round: i=0 → role[0], i=1 → role[1], i=2 → role[2], i=3 → role[0], i=4 → role[1], i=5 → role[2]. Cycles correctly.

Review count formula (Stage 2, line 641):
```python
advisors = [a for a in advisors_pool if a.name != founder.name]
```
With 6 all-do-everything providers, each founder sees 5 advisors.
With 3-advisor / 1-founder split config, the founder (non-advisor) sees 3 advisors; if founder is also in advisors pool, they see 2 (len(advisors) - 1).

For the 2-founder test: use `roles_config` to split 4 mock providers into 2 founders + 4 advisors (all 4). Each founder's advisor pool = all 4 - founder self = 3 advisors each. So per round: 2 founders * 3 reviews = 6 reviews. (len(advisors) - 1 where advisors includes the founders too.)

For the 6-provider test: use `mock_providers=[MockProvider(name) for name in ["p1","p2","p3","p4","p5","p6"]]`.
All-do-everything (no roles_config). Each founder pitches to 5 investors.
Feedback: 6 founders * 5 ideas each * 5 reviewers (all except self) = 150 items.
Selections: 6. Decisions: 6 * 5 = 30.
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add TestDynamicProviderCount class — 2-founder and 6-provider tests</name>
  <files>tests/test_pipeline.py</files>
  <behavior>
    - test_dyn01_two_founder_run_completes: 2-founder roles_config run completes all stages; stage1_ideas.jsonl, stage2_final_plans.jsonl, stage3_decisions.jsonl, portfolio_report.csv all exist
    - test_dyn02_six_provider_run_completes: 6-provider mock_providers run completes all stages; all expected output files exist
    - test_dyn03_advisor_role_rotation_six_providers: 6 advisors assigned roles using % 3 — role indices for i=0..5 at round 1 are [0,1,2,0,1,2] — verified via monkeypatching review_task or directly from ADVISOR_ROLES modulo logic
    - test_dyn04_review_count_two_founder: 2-founder + 4-advisor config (roles_config splits 4 mock providers: 2 founders, 4 advisors); each founder reviews from 3 advisors (4 total minus self); per-round total = 2 founders * 3 reviews = 6; after 1 iteration run, stage2_all_reviews.jsonl has 6 * max_iterations records (capped at convergence)
    - test_dyn04_review_count_six_providers: 6 mock providers all-do-everything; each founder reviewed by 5 advisors (6 - self); after 1 iteration, reviews = 6 * 5 = 30 in all_reviews
    - test_dyn05_one_founder_still_passes: verify TestRoleAssignment.test_pipeline_with_single_founder style run still works — this is a confidence check confirming the existing 1-founder test and plan 01 changes didn't break it
  </behavior>
  <action>
Add the following class AFTER the existing `TestFlexibleIdeas` class and BEFORE the schema tests in `tests/test_pipeline.py`.

```python
# ---------------------------------------------------------------------------
# Dynamic Provider Count Tests (Phase 6)
# ---------------------------------------------------------------------------


class TestDynamicProviderCount:
    """DYN-01 through DYN-05: pipeline works correctly with 2, 4, and 6 providers."""

    def test_dyn01_two_founder_run_completes(self, tmp_path, monkeypatch):
        """DYN-01: A 2-founder configuration completes all three stages.

        Uses roles_config to split the default 4 mock providers: 2 founders,
        all 4 as advisors (founder self-review is skipped at line 641 of run.py).
        """
        monkeypatch.chdir(tmp_path)
        run_dir = run_pipeline(
            use_mock=True,
            concurrency=1,
            retry_max=1,
            max_iterations=1,
            ideas_per_provider=2,
            roles_config={
                "founders": ["openai", "anthropic"],
                "advisors": ["openai", "anthropic", "deepseek", "gemini"],
                "investors": ["deepseek", "gemini"],
            },
        )
        assert run_dir.exists()
        assert (run_dir / "stage1_ideas.jsonl").exists()
        assert (run_dir / "stage2_final_plans.jsonl").exists()
        assert (run_dir / "stage3_decisions.jsonl").exists()
        assert (run_dir / "portfolio_report.csv").exists()

        # 2 founders -> 2 selections, 2 plans, 2 pitches
        selections = _read_jsonl(run_dir / "stage1_selections.jsonl")
        assert len(selections) == 2, f"Expected 2 selections (2 founders), got {len(selections)}"
        plans = _read_jsonl(run_dir / "stage2_final_plans.jsonl")
        assert len(plans) == 2, f"Expected 2 final plans, got {len(plans)}"
        # 2 founders * 2 investors each = 4 decisions
        decisions = _read_jsonl(run_dir / "stage3_decisions.jsonl")
        assert len(decisions) == 4, f"Expected 4 investor decisions (2 founders * 2 investors), got {len(decisions)}"

    def test_dyn02_six_provider_run_completes(self, tmp_path, monkeypatch):
        """DYN-02: A 6-provider all-do-everything run completes all three stages.

        Uses the mock_providers param (added in Plan 01) to inject 6 named providers.
        All six act as founders, advisors, and investors (no roles_config = all do everything).
        """
        from vc_agents.providers.mock import MockProvider as _MP
        monkeypatch.chdir(tmp_path)
        six_providers = [_MP(f"provider_{i}") for i in range(6)]
        run_dir = run_pipeline(
            use_mock=True,
            concurrency=1,
            retry_max=1,
            max_iterations=1,
            ideas_per_provider=2,
            mock_providers=six_providers,
        )
        assert run_dir.exists()
        assert (run_dir / "stage1_ideas.jsonl").exists()
        assert (run_dir / "stage2_final_plans.jsonl").exists()
        assert (run_dir / "stage3_decisions.jsonl").exists()
        assert (run_dir / "portfolio_report.csv").exists()

        plans = _read_jsonl(run_dir / "stage2_final_plans.jsonl")
        assert len(plans) == 6, f"Expected 6 final plans (6 founders), got {len(plans)}"
        # 6 founders each pitch to 5 investors (everyone except self) = 30
        decisions = _read_jsonl(run_dir / "stage3_decisions.jsonl")
        expected_decisions = 6 * (6 - 1)
        assert len(decisions) == expected_decisions, (
            f"Expected {expected_decisions} investor decisions (6 founders * 5 investors), "
            f"got {len(decisions)}"
        )

    def test_dyn03_advisor_role_rotation_six_providers(self, tmp_path, monkeypatch):
        """DYN-03: Advisor role rotation cycles through ADVISOR_ROLES correctly with 6 advisors.

        With 6 advisors and ADVISOR_ROLES having 3 entries, role indices at round 1
        are [0, 1, 2, 0, 1, 2] (i + round_num - 1) % 3 for i = 0..5.
        This test verifies the run completes (roles assigned without IndexError) AND
        that the captured role assignments cycle as expected via monkeypatching.
        """
        from vc_agents.providers.mock import MockProvider as _MP
        import vc_agents.pipeline.run as run_module

        monkeypatch.chdir(tmp_path)
        six_providers = [_MP(f"adv_{i}") for i in range(6)]

        # Capture role keys assigned to each advisor during reviews
        captured_roles: list[str] = []
        original_retry = run_module.retry_json_call

        def capturing_retry(provider, prompt, schema, context, max_retries, system=""):
            # Detect advisor review calls by context prefix
            if context.startswith("review ("):
                # Extract role key from prompt — it contains advisor_role= value
                for line in prompt.splitlines():
                    if "market_strategist" in line or "technical_advisor" in line or "financial_advisor" in line:
                        for role_key in ("market_strategist", "technical_advisor", "financial_advisor"):
                            if role_key in line:
                                captured_roles.append(role_key)
                                break
                        break
            return original_retry(provider, prompt, schema, context, max_retries, system=system)

        monkeypatch.setattr(run_module, "retry_json_call", capturing_retry)

        run_pipeline(
            use_mock=True,
            concurrency=1,
            retry_max=1,
            max_iterations=1,
            ideas_per_provider=2,
            mock_providers=six_providers,
        )

        # With 6 providers all-do-everything, each of 6 founders has 5 advisors reviewing per round.
        # Total review calls = 6 founders * 5 advisors * 1 round = 30
        # All 3 roles must appear (rotation guarantees it with 5+ advisors)
        role_keys = {"market_strategist", "technical_advisor", "financial_advisor"}
        captured_set = set(captured_roles)
        assert captured_set == role_keys, (
            f"Expected all 3 advisor roles to appear in reviews, got: {captured_set}"
        )

    def test_dyn04_review_count_two_founder_config(self, tmp_path, monkeypatch):
        """DYN-04: Review count = len(advisors) - 1 when founder is also an advisor.

        Config: 2 founders (openai, anthropic) + 4 advisors (all 4 mock providers).
        Each founder's advisor pool = 4 - self = 3 advisors.
        After 1 iteration: 2 founders * 3 reviews = 6 total review records.
        """
        monkeypatch.chdir(tmp_path)
        run_dir = run_pipeline(
            use_mock=True,
            concurrency=1,
            retry_max=1,
            max_iterations=1,
            ideas_per_provider=2,
            roles_config={
                "founders": ["openai", "anthropic"],
                "advisors": ["openai", "anthropic", "deepseek", "gemini"],
                "investors": ["deepseek", "gemini"],
            },
        )
        all_reviews = _read_jsonl(run_dir / "stage2_all_reviews.jsonl")
        # 2 founders * 3 reviewers each (4 advisors - self) * 1 round = 6
        # Note: max_iterations=1 means 1 round of reviews before convergence check
        expected = 2 * 3 * 1
        assert len(all_reviews) == expected, (
            f"Expected {expected} advisor reviews (2 founders * 3 advisors * 1 round), "
            f"got {len(all_reviews)}"
        )

    def test_dyn04_review_count_six_providers(self, tmp_path, monkeypatch):
        """DYN-04: Review count = len(advisors) - 1 with 6 all-do-everything providers.

        Each founder's advisor pool = 6 - self = 5 advisors.
        After 1 iteration: 6 founders * 5 reviews = 30 total review records.
        """
        from vc_agents.providers.mock import MockProvider as _MP
        monkeypatch.chdir(tmp_path)
        six_providers = [_MP(f"provider_{i}") for i in range(6)]
        run_dir = run_pipeline(
            use_mock=True,
            concurrency=1,
            retry_max=1,
            max_iterations=1,
            ideas_per_provider=2,
            mock_providers=six_providers,
        )
        all_reviews = _read_jsonl(run_dir / "stage2_all_reviews.jsonl")
        # 6 founders * 5 reviewers (6 - self) * 1 round = 30
        expected = 6 * (6 - 1) * 1
        assert len(all_reviews) == expected, (
            f"Expected {expected} advisor reviews (6 founders * 5 advisors * 1 round), "
            f"got {len(all_reviews)}"
        )

    def test_dyn05_one_founder_still_passes(self, tmp_path, monkeypatch):
        """DYN-05: Confirm 1-founder config still works after Phase 6 changes.

        Mirrors TestRoleAssignment.test_pipeline_with_single_founder to ensure
        Plan 01 changes (mock_providers param) did not break the 1-founder path.
        """
        monkeypatch.chdir(tmp_path)
        run_dir = run_pipeline(
            use_mock=True,
            concurrency=1,
            retry_max=1,
            max_iterations=1,
            ideas_per_provider=2,
            roles_config={
                "founders": ["anthropic"],
                "advisors": ["openai", "deepseek", "gemini"],
                "investors": ["openai", "deepseek", "gemini"],
            },
        )
        assert run_dir.exists()
        plans = _read_jsonl(run_dir / "stage2_final_plans.jsonl")
        assert len(plans) == 1, f"Expected 1 final plan for 1 founder, got {len(plans)}"
        decisions = _read_jsonl(run_dir / "stage3_decisions.jsonl")
        assert len(decisions) == 3, f"Expected 3 investor decisions (1 founder * 3 investors), got {len(decisions)}"
```

Place this class after `TestFlexibleIdeas` (which ends around line 793) and before the schema test classes. Insert a blank line and the `# -----------` section comment separator as shown above.

The `_read_jsonl` helper is defined at line 160 in the existing test file — no need to redeclare it.

Do NOT import MockProvider at the top of the new class — use the local import pattern `from vc_agents.providers.mock import MockProvider as _MP` inside the methods that need 6 providers (to avoid shadowing the top-level import used by other tests).
  </action>
  <verify>
    <automated>cd "C:/Users/Vince/Desktop/VC_AI_Incubator-main" && python -m pytest tests/test_pipeline.py::TestDynamicProviderCount -v 2>&1 | tail -20</automated>
  </verify>
  <done>All 6 tests in TestDynamicProviderCount pass. Each covers the required configuration: 1-founder, 2-founder, 6-provider, review count accuracy, and role rotation.</done>
</task>

<task type="auto">
  <name>Task 2: Full suite green check</name>
  <files></files>
  <action>
Run the complete test suite. Expected: all 69 original tests + 6 new tests = 75 tests pass.

If any new test fails, diagnose and fix:

1. `test_dyn04_review_count_two_founder_config` — if review count is wrong, check if MockProvider's mock review always signals `ready_for_pitch=True` which would cause early convergence. The MockProvider mock_review returns `ready_for_pitch=True` by default and the convergence check requires `round_num >= MIN_ROUNDS_BEFORE_CONVERGENCE (2)`. With `max_iterations=1`, the loop runs exactly 1 round (round 1), then hits `if round_num == max_iterations: break` — so exactly 1 round of reviews always fires regardless of convergence. This is correct; the expected count is `2 * 3 * 1 = 6`.

2. `test_dyn03_advisor_role_rotation_six_providers` — if role capture fails (captured_roles is empty), the monkeypatch may not match prompts correctly. The advisor_review_prompt.txt passes `advisor_role=role["key"]` which is one of the three key strings. The prompt formatter at line 646-655 inserts `advisor_role=role["key"]` into the prompt. Check the actual prompt format by reading `vc_agents/pipeline/prompts/advisor_review_prompt.txt` if needed and adjust the search pattern.

3. `test_dyn02_six_provider_run_completes` — if `stage2_all_founders_done` checkpoint logic fails for 6 providers, check that `_save_checkpoint` spread logic in run_stage2 correctly extends the list as each of 6 founders finishes.

Fix failures; re-run until all 75 pass.
  </action>
  <verify>
    <automated>cd "C:/Users/Vince/Desktop/VC_AI_Incubator-main" && python -m pytest tests/ -v 2>&1 | tail -10</automated>
  </verify>
  <done>All 75 tests pass (69 original + 6 new). `pytest tests/ -v` exits 0.</done>
</task>

</tasks>

<verification>
1. `TestDynamicProviderCount` class exists in tests/test_pipeline.py with 6 test methods
2. `test_dyn01_two_founder_run_completes` passes (DYN-01)
3. `test_dyn02_six_provider_run_completes` passes (DYN-02)
4. `test_dyn03_advisor_role_rotation_six_providers` passes (DYN-03)
5. `test_dyn04_review_count_two_founder_config` and `test_dyn04_review_count_six_providers` pass (DYN-04)
6. `test_dyn05_one_founder_still_passes` passes (DYN-05)
7. `pytest tests/ -v` exits 0 with 75 tests passing
</verification>

<success_criteria>
- All 5 DYN requirement IDs covered by at least one passing test each
- 1-founder, 2-founder, and 6-provider configurations all run end-to-end without errors
- Review count formula verified to be `len(advisors) - 1` when founder is in advisor pool
- Advisor role rotation confirmed to cycle across all 3 roles for 6-provider config
- `pytest tests/ -v` exits 0 with 75 tests total
</success_criteria>

<output>
After completion, create `.planning/phases/06-dynamic-provider-count/06-02-SUMMARY.md`
</output>
